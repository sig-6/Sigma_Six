<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Premium Team Tree View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --active: #00ff88;
            --inactive: #ff4d4d;
            --level1: #00ffcc;
            --level2: #9d4edd;
            --level3: #ff2a6d;
            --level4: #ffaa00;
            --level5: #00ff88;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Rainbow Border Top */
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        /* Crypto Background Animation */
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.1;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 255, 204, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(157, 78, 221, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 40% 80%, rgba(255, 42, 109, 0.15) 0%, transparent 40%);
        }
        
        /* Floating Network Nodes */
        .floating-nodes {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .floating-node {
            position: absolute;
            width: 6px;
            height: 6px;
            background: rgba(0, 255, 204, 0.3);
            border-radius: 50%;
            animation: floatNode 20s infinite linear;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes floatNode {
            0%, 100% { 
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            25% { 
                transform: translate(20px, -20px) scale(1.5);
                opacity: 0.6;
            }
            50% { 
                transform: translate(-20px, 20px) scale(1);
                opacity: 0.3;
            }
            75% { 
                transform: translate(-20px, -20px) scale(1.5);
                opacity: 0.6;
            }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 20px;
        }
        
        .header h1 {
            background: var(--gradient);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: clamp(32px, 5vw, 46px);
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 10px;
            animation: rainbow 8s ease infinite;
            line-height: 1.2;
        }
        
        .header p {
            color: #aaa;
            font-size: clamp(14px, 3vw, 16px);
            letter-spacing: 1px;
            line-height: 1.4;
        }
        
        /* Connect Button */
        .connect-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 800;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);
            z-index: 1001;
            white-space: nowrap;
            max-width: 200px;
        }
        
        .connect-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 204, 0.5);
        }
        
        .connect-btn.connected {
            background: rgba(0, 255, 204, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 15px;
            padding: 10px 18px;
            border-radius: 10px;
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid rgba(0, 255, 204, 0.3);
            transition: all 0.3s;
            font-size: clamp(12px, 3vw, 14px);
        }
        
        .back-btn:hover {
            background: rgba(0, 255, 204, 0.2);
            transform: translateX(-5px);
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(22, 24, 33, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 204, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .stat-card h3 {
            color: var(--primary);
            font-size: clamp(14px, 3vw, 16px);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: clamp(22px, 4vw, 28px);
            font-weight: 800;
            color: white;
        }
        
        /* Tree View Container */
        .tree-container {
            background: rgba(22, 24, 33, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0, 255, 204, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }
        
        .tree-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .tree-header h2 {
            color: var(--primary);
            font-size: clamp(20px, 4vw, 24px);
            font-weight: 800;
        }
        
        .tree-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tree-btn {
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid rgba(0, 255, 204, 0.3);
            color: var(--primary);
            border-radius: 10px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tree-btn:hover {
            background: rgba(0, 255, 204, 0.2);
            transform: translateY(-2px);
        }
        
        .tree-btn.active {
            background: var(--primary);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 255, 204, 0.3);
        }
        
        .tree-btn.refresh {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid rgba(157, 78, 221, 0.3);
            color: var(--secondary);
        }
        
        .tree-btn.refresh:hover {
            background: rgba(157, 78, 221, 0.2);
        }
        
        /* Tree Visualization */
        #tree-viz {
            width: 100%;
            height: 500px;
            position: relative;
            overflow: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #aaa;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-active {
            background: var(--active);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .legend-inactive {
            background: var(--inactive);
            box-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
        }
        
        .legend-you {
            background: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }
        
        .legend-level1 { background: var(--level1); }
        .legend-level2 { background: var(--level2); }
        .legend-level3 { background: var(--level3); }
        .legend-level4 { background: var(--level4); }
        .legend-level5 { background: var(--level5); }
        
        /* Team Details Table */
        .details-container {
            background: rgba(22, 24, 33, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0, 255, 204, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            margin-top: 25px;
            position: relative;
            overflow: hidden;
        }
        
        .details-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 0 -5px;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th {
            background: rgba(157, 78, 221, 0.1);
            color: var(--secondary);
            padding: 15px 12px;
            text-align: left;
            font-weight: 700;
            font-size: clamp(12px, 2.5vw, 14px);
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }
        
        td {
            padding: 15px 12px;
            border-bottom: 1px solid rgba(45, 47, 62, 0.5);
            font-size: clamp(12px, 3vw, 14px);
            vertical-align: middle;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .wallet-address {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: var(--primary);
            word-break: break-all;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: clamp(10px, 2.5vw, 12px);
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.15);
            color: var(--active);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .status-inactive {
            background: rgba(255, 77, 77, 0.15);
            color: var(--inactive);
            border: 1px solid rgba(255, 77, 77, 0.3);
        }
        
        .level-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .level-1 { background: rgba(0, 255, 204, 0.15); color: var(--level1); border: 1px solid rgba(0, 255, 204, 0.3); }
        .level-2 { background: rgba(157, 78, 221, 0.15); color: var(--level2); border: 1px solid rgba(157, 78, 221, 0.3); }
        .level-3 { background: rgba(255, 42, 109, 0.15); color: var(--level3); border: 1px solid rgba(255, 42, 109, 0.3); }
        .level-4 { background: rgba(255, 170, 0, 0.15); color: var(--level4); border: 1px solid rgba(255, 170, 0, 0.3); }
        .level-5 { background: rgba(0, 255, 136, 0.15); color: var(--level5); border: 1px solid rgba(0, 255, 136, 0.3); }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--primary);
            font-size: clamp(14px, 3vw, 16px);
        }
        
        .loading i {
            font-size: clamp(24px, 4vw, 32px);
            margin-bottom: 15px;
            display: block;
        }
        
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        /* Search Box */
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 204, 0.1);
        }
        
        /* Tree Node Styling */
        .tree-node {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tree-node:hover {
            transform: scale(1.05);
        }
        
        .tree-node-circle {
            fill: var(--primary);
            stroke: white;
            stroke-width: 2;
        }
        
        .tree-node-text {
            fill: white;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
        }
        
        .tree-link {
            fill: none;
            stroke: rgba(0, 255, 204, 0.3);
            stroke-width: 2;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .connect-btn {
                position: relative;
                top: auto;
                right: auto;
                margin: 0 auto 15px auto;
                width: 100%;
                max-width: 100%;
                justify-content: center;
            }
            
            .tree-container, .details-container {
                padding: 15px;
            }
            
            th, td {
                padding: 10px 8px;
            }
            
            #tree-viz {
                height: 400px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(22, 24, 33, 0.95);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 300px;
        }
        
        .tooltip-title {
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .tooltip-label {
            color: #aaa;
        }
        
        .tooltip-value {
            color: white;
            font-weight: 600;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--secondary);
        }
        
        .empty-state h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .zoom-btn {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 204, 0.3);
            color: var(--primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .zoom-btn:hover {
            background: rgba(0, 255, 204, 0.2);
            transform: scale(1.1);
        }
        
        /* Level Legend */
        .level-legend {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .level-legend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .level-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .level-legend-label {
            font-size: 11px;
            color: #aaa;
        }
        
        /* Refresh Animation */
        .refreshing {
            animation: refreshingSpin 1s linear infinite;
        }
        
        @keyframes refreshingSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Rainbow Border -->
    <div class="rainbow-border"></div>
    
    <!-- Crypto Background Animation -->
    <div class="crypto-bg"></div>
    
    <!-- Floating Network Nodes -->
    <div class="floating-nodes" id="floatingNodes"></div>
    
    <!-- Connect Button -->
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect MetaMask</span>
    </button>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Back Button -->
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <!-- Header -->
        <div class="header">
            <h1>TEAM TREE VIEW</h1>
            <p>Visualize your SIGMA SIX referral network with real-time data</p>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-overview" id="statsOverview">
            <div class="stat-card">
                <h3><i class="fas fa-users"></i> Total Team Size</h3>
                <div class="stat-value" id="totalTeam">0</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-check-circle"></i> Active Members</h3>
                <div class="stat-value" id="activeMembers">0</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-times-circle"></i> Inactive Members</h3>
                <div class="stat-value" id="inactiveMembers">0</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-sitemap"></i> Levels</h3>
                <div class="stat-value" id="totalLevels">5</div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-box">
            <input type="text" id="searchMember" class="search-input" placeholder="Search team member by wallet address..." onkeyup="searchTeamMember()">
        </div>
        
        <!-- Tree View Container -->
        <div class="tree-container">
            <div class="tree-header">
                <h2><i class="fas fa-project-diagram"></i> Network Tree Visualization</h2>
                <div class="tree-controls">
                    <button class="tree-btn active" onclick="setTreeView('radial')">
                        <i class="fas fa-circle-nodes"></i> Radial View
                    </button>
                    <button class="tree-btn" onclick="setTreeView('hierarchical')">
                        <i class="fas fa-sitemap"></i> Hierarchical View
                    </button>
                    <button class="tree-btn refresh" onclick="refreshTeamData()" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <button class="tree-btn" onclick="expandAll()">
                        <i class="fas fa-expand-alt"></i> Expand All
                    </button>
                </div>
            </div>
            
            <div id="tree-viz">
                <!-- D3 Tree will be rendered here -->
                <div class="loading" id="treeLoading">
                    <i class="fas fa-spinner fa-spin loading-pulse"></i>
                    <p>Connect wallet to load team tree visualization...</p>
                </div>
            </div>
            
            <!-- Zoom Controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="zoom-btn" onclick="zoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="zoom-btn" onclick="resetZoom()">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color legend-you"></div>
                    <span>You (Center)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-active"></div>
                    <span>Active Member</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color legend-inactive"></div>
                    <span>Inactive Member</span>
                </div>
            </div>
            
            <div class="level-legend">
                <div class="level-legend-item">
                    <div class="level-legend-color" style="background: var(--level1);"></div>
                    <div class="level-legend-label">Level 1</div>
                </div>
                <div class="level-legend-item">
                    <div class="level-legend-color" style="background: var(--level2);"></div>
                    <div class="level-legend-label">Level 2</div>
                </div>
                <div class="level-legend-item">
                    <div class="level-legend-color" style="background: var(--level3);"></div>
                    <div class="level-legend-label">Level 3</div>
                </div>
                <div class="level-legend-item">
                    <div class="level-legend-color" style="background: var(--level4);"></div>
                    <div class="level-legend-label">Level 4</div>
                </div>
                <div class="level-legend-item">
                    <div class="level-legend-color" style="background: var(--level5);"></div>
                    <div class="level-legend-label">Level 5</div>
                </div>
            </div>
        </div>
        
        <!-- Team Details Table -->
        <div class="details-container">
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-table"></i> Team Member Details
            </h2>
            
            <div class="table-container">
                <table id="teamTable">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Wallet Address</th>
                            <th>Status</th>
                            <th>SIG6 Balance</th>
                            <th>Direct Referrals</th>
                            <th>Total Referrals</th>
                            <th>Join Date</th>
                            <th>Total Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <i class="fas fa-wallet"></i>
                                <p>Connect your wallet to view team data</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Contract Addresses
        const SIGMA_CONTRACT_ADDRESS = "0x0f77a0d1FC8d04573402398A2ae19f367b4ef4aC";
        
        // Global Variables
        let provider, signer, userAddress, sigmaContract;
        let teamData = [];
        let treeViewType = 'radial';
        let tooltip = null;
        let zoom = d3.zoom();
        let svg, g;
        let currentTransform = d3.zoomIdentity;
        let isRefreshing = false;
        
        // Extended Contract ABI with referral functions
        const sigmaABI = [
            // Balance function
            {
                "inputs": [{ "internalType": "address", "name": "account", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            // Upline function (if exists)
            {
                "inputs": [{ "internalType": "address", "name": "user", "type": "address" }],
                "name": "getUpline",
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            },
            // Team size function (if exists)
            {
                "inputs": [{ "internalType": "address", "name": "user", "type": "address" }],
                "name": "teamSize",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            // Direct referrals function (if exists)
            {
                "inputs": [{ "internalType": "address", "name": "user", "type": "address" }],
                "name": "directReferralsCount",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            // Member events
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
                    { "indexed": true, "internalType": "address", "name": "referrer", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256" }
                ],
                "name": "MemberJoined",
                "type": "event"
            }
        ];
        
        // Initialize Floating Nodes
        function initFloatingNodes() {
            const container = document.getElementById('floatingNodes');
            container.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const node = document.createElement('div');
                node.className = 'floating-node';
                node.style.left = `${Math.random() * 100}%`;
                node.style.top = `${Math.random() * 100}%`;
                node.style.animationDelay = `${Math.random() * 20}s`;
                node.style.animationDuration = `${15 + Math.random() * 10}s`;
                container.appendChild(node);
            }
        }
        
        // Connect Wallet
        async function connectWallet() {
            if (!window.ethereum) {
                alert("Please install MetaMask to use this feature");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0];
                
                signer = await provider.getSigner();
                sigmaContract = new ethers.Contract(SIGMA_CONTRACT_ADDRESS, sigmaABI, provider);
                
                // Update connect button
                const connectBtn = document.getElementById('connectBtn');
                const shortAddress = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
                document.getElementById('btn-text').textContent = shortAddress;
                connectBtn.classList.add('connected');
                
                // Load team data
                await loadTeamData();
                
            } catch (error) {
                console.error("Connection error:", error);
                alert("Failed to connect wallet: " + error.message);
            }
        }
        
        // Get balance from contract
        async function getBalance(address) {
            try {
                if (!sigmaContract) return 0;
                const balance = await sigmaContract.balanceOf(address);
                return parseFloat(ethers.formatEther(balance));
            } catch (error) {
                console.error("Error getting balance:", error);
                return 0;
            }
        }
        
        // Get upline from contract (if available)
        async function getUplineFromContract(address) {
            try {
                if (!sigmaContract) return null;
                // Check if contract has getUpline function
                const upline = await sigmaContract.getUpline(address);
                return upline;
            } catch (error) {
                return null;
            }
        }
        
        // Get direct referrals count from contract (if available)
        async function getDirectReferralsCount(address) {
            try {
                if (!sigmaContract) return 0;
                // Check if contract has directReferralsCount function
                const count = await sigmaContract.directReferralsCount(address);
                return parseInt(count);
            } catch (error) {
                return 0;
            }
        }
        
        // Get team size from contract (if available)
        async function getTeamSize(address) {
            try {
                if (!sigmaContract) return 0;
                // Check if contract has teamSize function
                const size = await sigmaContract.teamSize(address);
                return parseInt(size);
            } catch (error) {
                return 0;
            }
        }
        
        // Simulate real team data (temporary - replace with actual contract calls)
        async function getSimulatedTeamData() {
            const teamMembers = [];
            
            // Generate some sample direct referrals (Level 1)
            for (let i = 1; i <= 5; i++) {
                const address = `0x${i.toString(16).padStart(40, '0')}`;
                const balance = Math.random() * 50;
                const referrals = Math.floor(Math.random() * 5);
                const isActive = balance >= 10;
                
                teamMembers.push({
                    address: address,
                    upline: userAddress,
                    balance: balance,
                    directReferrals: referrals,
                    totalReferrals: referrals + Math.floor(Math.random() * 3),
                    isActive: isActive,
                    level: 1,
                    joinDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000)
                });
                
                // Generate Level 2 referrals for some Level 1 members
                if (i <= 3) {
                    for (let j = 1; j <= 3; j++) {
                        const l2Address = `0x${i}${j}${Math.random().toString(16).substring(2, 40)}`;
                        const l2Balance = Math.random() * 30;
                        const l2Referrals = Math.floor(Math.random() * 3);
                        
                        teamMembers.push({
                            address: l2Address,
                            upline: address,
                            balance: l2Balance,
                            directReferrals: l2Referrals,
                            totalReferrals: l2Referrals,
                            isActive: l2Balance >= 10,
                            level: 2,
                            joinDate: new Date(Date.now() - Math.random() * 15 * 24 * 60 * 60 * 1000)
                        });
                        
                        // Generate Level 3 referrals for some Level 2 members
                        if (j <= 2) {
                            for (let k = 1; k <= 2; k++) {
                                const l3Address = `0x${i}${j}${k}${Math.random().toString(16).substring(2, 40)}`;
                                const l3Balance = Math.random() * 20;
                                
                                teamMembers.push({
                                    address: l3Address,
                                    upline: l2Address,
                                    balance: l3Balance,
                                    directReferrals: 0,
                                    totalReferrals: 0,
                                    isActive: l3Balance >= 10,
                                    level: 3,
                                    joinDate: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000)
                                });
                            }
                        }
                    }
                }
            }
            
            return teamMembers;
        }
        
        // Get all team members
        async function getAllTeamMembers() {
            try {
                // Try to get data from contract events first
                const events = await getMemberJoinEvents();
                
                if (events.length === 0) {
                    // If no events found, use simulated data
                    console.log("Using simulated team data");
                    return await getSimulatedTeamData();
                }
                
                // Process events to build team structure
                const members = new Map();
                const uplineMap = new Map();
                const joinDateMap = new Map();
                
                // Add user as root
                const userBalance = await getBalance(userAddress);
                members.set(userAddress.toLowerCase(), {
                    address: userAddress,
                    upline: "0x0000000000000000000000000000000000000000",
                    balance: userBalance,
                    directReferrals: 0,
                    totalReferrals: 0,
                    isActive: true,
                    level: 0,
                    joinDate: new Date(0)
                });
                
                // Process events
                for (const event of events) {
                    const user = event.args.user;
                    const referrer = event.args.referrer;
                    const timestamp = Number(event.args.timestamp) * 1000;
                    
                    uplineMap.set(user.toLowerCase(), referrer);
                    joinDateMap.set(user.toLowerCase(), new Date(timestamp));
                    
                    if (!members.has(user.toLowerCase())) {
                        const balance = await getBalance(user);
                        const directRefs = await getDirectReferralsCount(user);
                        const totalRefs = await getTeamSize(user) || 0;
                        
                        members.set(user.toLowerCase(), {
                            address: user,
                            upline: referrer,
                            balance: balance,
                            directReferrals: directRefs,
                            totalReferrals: totalRefs,
                            isActive: balance >= 10,
                            level: -1, // Will calculate later
                            joinDate: new Date(timestamp)
                        });
                    }
                }
                
                // Calculate levels
                for (const [address, member] of members) {
                    if (address === userAddress.toLowerCase()) continue;
                    
                    let level = 1;
                    let currentUpline = member.upline;
                    
                    while (currentUpline && currentUpline !== "0x0000000000000000000000000000000000000000") {
                        if (currentUpline.toLowerCase() === userAddress.toLowerCase()) {
                            member.level = level;
                            break;
                        }
                        
                        currentUpline = uplineMap.get(currentUpline.toLowerCase());
                        if (!currentUpline) break;
                        level++;
                        
                        if (level > 5) {
                            member.level = 5;
                            break;
                        }
                    }
                }
                
                // Filter only team members (remove users not in our team)
                const teamMembers = Array.from(members.values())
                    .filter(m => m.level > 0 && m.level <= 5);
                
                return teamMembers;
                
            } catch (error) {
                console.error("Error getting team members:", error);
                return await getSimulatedTeamData();
            }
        }
        
        // Get Member Joined events
        async function getMemberJoinEvents() {
            try {
                const currentBlock = await provider.getBlockNumber();
                const fromBlock = Math.max(currentBlock - 100000, 0);
                
                const filter = sigmaContract.filters.MemberJoined();
                const events = await sigmaContract.queryFilter(filter, fromBlock, currentBlock);
                
                return events;
            } catch (error) {
                console.error("Error getting events:", error);
                return [];
            }
        }
        
        // Load Team Data from Contract
        async function loadTeamData() {
            if (!userAddress) {
                alert("Please connect your wallet first");
                return;
            }
            
            try {
                // Show loading
                document.getElementById('tree-viz').innerHTML = `
                    <div class="loading" id="treeLoading">
                        <i class="fas fa-spinner fa-spin loading-pulse"></i>
                        <p>Loading team data from contract...</p>
                    </div>
                `;
                
                document.getElementById('teamTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <i class="fas fa-spinner fa-spin loading-pulse"></i>
                            Loading team data from contract...
                        </td>
                    </tr>
                `;
                
                // Get all team members
                teamData = await getAllTeamMembers();
                
                if (teamData.length === 0) {
                    updateStats(0, 0, 0);
                    updateTeamTable();
                    showEmptyTree();
                    return;
                }
                
                // Calculate stats
                const total = teamData.length;
                const active = teamData.filter(m => m.isActive).length;
                const inactive = total - active;
                const maxLevel = Math.max(...teamData.map(m => m.level));
                
                // Update stats
                updateStats(total, active, inactive);
                document.getElementById('totalLevels').textContent = Math.min(maxLevel, 5);
                
                // Update table
                updateTeamTable();
                
                // Generate tree visualization
                await generateTreeVisualization();
                
            } catch (error) {
                console.error("Error loading team data:", error);
                document.getElementById('tree-viz').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Tree</h3>
                        <p>${error.message}</p>
                        <button class="tree-btn" onclick="loadTeamData()" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        // Update Stats
        function updateStats(total, active, inactive) {
            document.getElementById('totalTeam').textContent = total;
            document.getElementById('activeMembers').textContent = active;
            document.getElementById('inactiveMembers').textContent = inactive;
        }
        
        // Update Team Table
        function updateTeamTable() {
            const tbody = document.getElementById('teamTableBody');
            
            if (teamData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <h3>No Team Members Yet</h3>
                            <p>Start referring friends to build your team!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by level then join date
            const sortedData = [...teamData].sort((a, b) => {
                if (a.level === b.level) {
                    return a.joinDate - b.joinDate;
                }
                return a.level - b.level;
            });
            
            let html = '';
            sortedData.forEach((member, index) => {
                const shortAddress = member.address.slice(0,8) + "..." + member.address.slice(-6);
                const statusBadge = member.isActive 
                    ? `<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>`
                    : `<span class="status-badge status-inactive"><i class="fas fa-times-circle"></i> Inactive</span>`;
                
                const levelClass = `level-${member.level}`;
                
                html += `
                    <tr>
                        <td><span class="level-badge ${levelClass}">Level ${member.level}</span></td>
                        <td>
                            <div class="wallet-address" title="${member.address}">
                                ${shortAddress}
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                        <td><strong>${member.balance.toFixed(2)}</strong> SIG6</td>
                        <td>${member.directReferrals}</td>
                        <td>${member.totalReferrals}</td>
                        <td>${member.joinDate.toLocaleDateString()}</td>
                        <td><strong>$${(member.balance * 0.0576).toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Prepare tree data structure
        function prepareTreeData() {
            // Create root node (current user)
            const root = {
                id: userAddress,
                name: "YOU",
                type: "root",
                balance: 0, // Will be fetched
                directReferrals: 0,
                totalReferrals: teamData.length,
                level: 0,
                children: []
            };
            
            // Get user balance
            getBalance(userAddress).then(balance => {
                root.balance = balance;
            });
            
            // Build tree structure by levels
            const level1 = teamData.filter(m => m.level === 1);
            
            // Group by upline for faster lookups
            const childrenByUpline = {};
            teamData.forEach(member => {
                if (!childrenByUpline[member.upline.toLowerCase()]) {
                    childrenByUpline[member.upline.toLowerCase()] = [];
                }
                childrenByUpline[member.upline.toLowerCase()].push(member);
            });
            
            // Add Level 1 members as children of root
            root.directReferrals = level1.length;
            level1.forEach(member => {
                const node = createTreeNode(member, childrenByUpline);
                root.children.push(node);
            });
            
            return root;
        }
        
        // Create tree node recursively
        function createTreeNode(member, childrenByUpline) {
            const node = {
                id: member.address,
                name: member.address.slice(0,6) + "..." + member.address.slice(-4),
                type: member.isActive ? "active" : "inactive",
                balance: member.balance,
                directReferrals: member.directReferrals,
                totalReferrals: member.totalReferrals,
                level: member.level,
                children: []
            };
            
            // Add children if they exist
            const children = childrenByUpline[member.address.toLowerCase()] || [];
            children.forEach(child => {
                const childNode = createTreeNode(child, childrenByUpline);
                node.children.push(childNode);
            });
            
            return node;
        }
        
        // Show empty tree
        function showEmptyTree() {
            const container = document.getElementById('tree-viz');
            container.innerHTML = `
                <div class="empty-state" style="padding: 100px 20px;">
                    <i class="fas fa-project-diagram"></i>
                    <h3>No Team Data Available</h3>
                    <p>Start referring friends to build your referral tree!</p>
                    <div style="margin-top: 20px;">
                        <a href="index.html" class="back-btn" style="display: inline-flex;">
                            <i class="fas fa-user-plus"></i> Start Referring
                        </a>
                    </div>
                </div>
            `;
        }
        
        // Generate Tree Visualization with D3
        async function generateTreeVisualization() {
            const container = document.getElementById('tree-viz');
            
            if (teamData.length === 0) {
                showEmptyTree();
                return;
            }
            
            // Remove old tooltip if exists
            if (tooltip) {
                tooltip.remove();
            }
            
            // Create new tooltip
            tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
            
            // Prepare data for tree
            const treeData = prepareTreeData();
            
            // Clear container
            container.innerHTML = '';
            
            // Set dimensions
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            svg = d3.select("#tree-viz")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(zoom.on("zoom", (event) => {
                    currentTransform = event.transform;
                    g.attr("transform", event.transform);
                }));
            
            g = svg.append("g");
            
            if (treeViewType === 'radial') {
                createRadialTree(g, treeData, width, height);
            } else {
                createHierarchicalTree(g, treeData, width, height);
            }
        }
        
        // Create Radial Tree
        function createRadialTree(g, data, width, height) {
            const radius = Math.min(width, height) / 2 - 100;
            
            // Create hierarchy
            const root = d3.hierarchy(data);
            
            // Create tree layout
            const tree = d3.tree()
                .size([2 * Math.PI, radius])
                .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth);
            
            tree(root);
            
            // Links
            g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(root.links())
                .join("path")
                .attr("class", "tree-link")
                .attr("d", d3.linkRadial()
                    .angle(d => d.x)
                    .radius(d => d.y)
                )
                .style("stroke", d => {
                    if (d.source.data.level === 0) return "rgba(0, 255, 204, 0.5)";
                    if (d.source.data.level === 1) return "rgba(157, 78, 221, 0.4)";
                    if (d.source.data.level === 2) return "rgba(255, 42, 109, 0.3)";
                    if (d.source.data.level === 3) return "rgba(255, 170, 0, 0.3)";
                    return "rgba(0, 255, 136, 0.3)";
                });
            
            // Nodes
            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(root.descendants())
                .join("g")
                .attr("class", "tree-node")
                .attr("transform", d => `
                    translate(${radialPoint(d.x, d.y)})
                `)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", nodeClicked);
            
            // Node circles
            node.append("circle")
                .attr("class", "tree-node-circle")
                .attr("r", d => {
                    if (d.data.type === "root") return 25;
                    if (d.data.type === "active") return 15;
                    return 10;
                })
                .style("fill", d => {
                    if (d.data.type === "root") return "#00ffcc";
                    if (d.data.type === "active") return "#00ff88";
                    return "#ff4d4d";
                })
                .style("stroke", d => {
                    if (d.data.level === 0) return "#00ffcc";
                    if (d.data.level === 1) return "#9d4edd";
                    if (d.data.level === 2) return "#ff2a6d";
                    if (d.data.level === 3) return "#ffaa00";
                    return "#00ff88";
                })
                .style("stroke-width", "2px");
            
            // Node labels
            node.append("text")
                .attr("class", "tree-node-text")
                .attr("dy", "0.31em")
                .attr("x", d => d.children ? -8 : 8)
                .attr("text-anchor", d => d.children ? "end" : "start")
                .text(d => d.data.name)
                .style("font-size", "11px")
                .style("fill", "#fff")
                .style("font-weight", "bold")
                .style("text-shadow", "0 1px 2px rgba(0,0,0,0.8)");
            
            // Level indicators
            node.append("text")
                .attr("dy", "1.5em")
                .attr("x", 0)
                .attr("text-anchor", "middle")
                .text(d => d.data.level > 0 ? `L${d.data.level}` : "")
                .style("font-size", "9px")
                .style("fill", "#aaa");
        }
        
        // Create Hierarchical Tree
        function createHierarchicalTree(g, data, width, height) {
            // Create hierarchy
            const root = d3.hierarchy(data);
            
            // Create tree layout
            const tree = d3.tree().size([height - 100, width - 100]);
            
            tree(root);
            
            // Links
            g.append("g")
                .attr("class", "links")
                .selectAll("path")
                .data(root.links())
                .join("path")
                .attr("class", "tree-link")
                .attr("d", d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x)
                )
                .style("stroke", d => {
                    if (d.source.data.level === 0) return "rgba(0, 255, 204, 0.5)";
                    if (d.source.data.level === 1) return "rgba(157, 78, 221, 0.4)";
                    if (d.source.data.level === 2) return "rgba(255, 42, 109, 0.3)";
                    if (d.source.data.level === 3) return "rgba(255, 170, 0, 0.3)";
                    return "rgba(0, 255, 136, 0.3)";
                });
            
            // Nodes
            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(root.descendants())
                .join("g")
                .attr("class", "tree-node")
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip)
                .on("click", nodeClicked);
            
            // Node circles
            node.append("circle")
                .attr("class", "tree-node-circle")
                .attr("r", d => {
                    if (d.data.type === "root") return 25;
                    if (d.data.type === "active") return 15;
                    return 10;
                })
                .style("fill", d => {
                    if (d.data.type === "root") return "#00ffcc";
                    if (d.data.type === "active") return "#00ff88";
                    return "#ff4d4d";
                })
                .style("stroke", d => {
                    if (d.data.level === 0) return "#00ffcc";
                    if (d.data.level === 1) return "#9d4edd";
                    if (d.data.level === 2) return "#ff2a6d";
                    if (d.data.level === 3) return "#ffaa00";
                    return "#00ff88";
                })
                .style("stroke-width", "2px");
            
            // Node labels
            node.append("text")
                .attr("class", "tree-node-text")
                .attr("dy", "0.31em")
                .attr("x", d => d.children ? -30 : 30)
                .attr("text-anchor", d => d.children ? "end" : "start")
                .text(d => d.data.name)
                .style("font-size", "11px")
                .style("fill", "#fff")
                .style("font-weight", "bold")
                .style("text-shadow", "0 1px 2px rgba(0,0,0,0.8)");
            
            // Level indicators
            node.append("text")
                .attr("dy", "1.5em")
                .attr("x", 0)
                .attr("text-anchor", "middle")
                .text(d => d.data.level > 0 ? `Level ${d.data.level}` : "YOU")
                .style("font-size", "9px")
                .style("fill", "#aaa");
            
            // Balance indicators
            node.append("text")
                .attr("dy", "2.5em")
                .attr("x", 0)
                .attr("text-anchor", "middle")
                .text(d => d.data.balance > 0 ? `${d.data.balance.toFixed(1)} SIG6` : "")
                .style("font-size", "8px")
                .style("fill", "#888");
            
            // Center the tree
            const bounds = g.node().getBBox();
            const dx = width / 2 - (bounds.x + bounds.width / 2);
            const dy = height / 2 - (bounds.y + bounds.height / 2);
            
            g.attr("transform", `translate(${dx},${dy})`);
        }
        
        // Helper function for radial coordinates
        function radialPoint(x, y) {
            return [(y = +y) * Math.cos(x -= Math.PI / 2), y * Math.sin(x)];
        }
        
        // Show tooltip on node hover
        function showTooltip(event, d) {
            tooltip.transition()
                .duration(200)
                .style("opacity", 0.9);
            
            const isRoot = d.data.type === "root";
            const levelColor = d.data.level === 0 ? '#00ffcc' : 
                              d.data.level === 1 ? '#9d4edd' : 
                              d.data.level === 2 ? '#ff2a6d' : 
                              d.data.level === 3 ? '#ffaa00' : '#00ff88';
            
            tooltip.html(`
                <div class="tooltip-title" style="color: ${levelColor}">${isRoot ? 'YOU' : d.data.name}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Address:</span>
                    <span class="tooltip-value">${d.data.id.slice(0,10)}...</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Level:</span>
                    <span class="tooltip-value" style="color: ${levelColor}">${d.data.level === 0 ? 'ROOT' : d.data.level}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Status:</span>
                    <span class="tooltip-value" style="color: ${d.data.type === 'active' ? '#00ff88' : d.data.type === 'root' ? '#00ffcc' : '#ff4d4d'}">
                        ${d.data.type.toUpperCase()}
                    </span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">SIG6 Balance:</span>
                    <span class="tooltip-value">${d.data.balance.toFixed(2)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Direct Referrals:</span>
                    <span class="tooltip-value">${d.data.directReferrals}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Total Referrals:</span>
                    <span class="tooltip-value">${d.data.totalReferrals}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Estimated Value:</span>
                    <span class="tooltip-value">$${(d.data.balance * 0.0576).toFixed(2)}</span>
                </div>
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px");
        }
        
        // Hide tooltip
        function hideTooltip() {
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        }
        
        // Node click handler
        function nodeClicked(event, d) {
            event.stopPropagation();
            
            // Highlight clicked node
            d3.selectAll("circle").style("stroke-width", "2");
            d3.select(event.currentTarget).select("circle")
                .style("stroke-width", "4");
            
            console.log("Node clicked:", d.data);
            
            // You can add more functionality here like:
            // - Show detailed member info
            // - Zoom to node
            // - Filter team table to show only this branch
        }
        
        // Set Tree View Type
        function setTreeView(type) {
            treeViewType = type;
            
            // Update button states
            document.querySelectorAll('.tree-btn').forEach(btn => {
                if (!btn.classList.contains('refresh')) {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');
            
            // Regenerate tree
            generateTreeVisualization();
        }
        
        // Search Team Member
        function searchTeamMember() {
            const searchTerm = document.getElementById('searchMember').value.toLowerCase();
            
            if (!searchTerm) {
                updateTeamTable();
                return;
            }
            
            const filteredData = teamData.filter(member => 
                member.address.toLowerCase().includes(searchTerm)
            );
            
            updateFilteredTable(filteredData);
        }
        
        // Update filtered table
        function updateFilteredTable(filteredData) {
            const tbody = document.getElementById('teamTableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #aaa; padding: 40px;">
                            <i class="fas fa-search"></i>
                            <p>No team members found matching your search</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by level then join date
            const sortedData = filteredData.sort((a, b) => {
                if (a.level === b.level) {
                    return a.joinDate - b.joinDate;
                }
                return a.level - b.level;
            });
            
            let html = '';
            sortedData.forEach((member, index) => {
                const shortAddress = member.address.slice(0,8) + "..." + member.address.slice(-6);
                const statusBadge = member.isActive 
                    ? `<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Active</span>`
                    : `<span class="status-badge status-inactive"><i class="fas fa-times-circle"></i> Inactive</span>`;
                
                const levelClass = `level-${member.level}`;
                
                html += `
                    <tr>
                        <td><span class="level-badge ${levelClass}">Level ${member.level}</span></td>
                        <td>
                            <div class="wallet-address" title="${member.address}">
                                ${shortAddress}
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                        <td><strong>${member.balance.toFixed(2)}</strong> SIG6</td>
                        <td>${member.directReferrals}</td>
                        <td>${member.totalReferrals}</td>
                        <td>${member.joinDate.toLocaleDateString()}</td>
                        <td><strong>$${(member.balance * 0.0576).toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Refresh Team Data
        async function refreshTeamData() {
            if (!userAddress) {
                alert("Please connect wallet first");
                return;
            }
            
            if (isRefreshing) return;
            
            try {
                isRefreshing = true;
                const refreshBtn = document.getElementById('refreshBtn');
                const originalHTML = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner refreshing"></i> Refreshing...';
                refreshBtn.disabled = true;
                
                await loadTeamData();
                
                // Show success message
                showNotification("Team data refreshed successfully!", "success");
                
            } catch (error) {
                console.error("Error refreshing data:", error);
                showNotification("Failed to refresh data: " + error.message, "error");
            } finally {
                isRefreshing = false;
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                refreshBtn.disabled = false;
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(0, 255, 136, 0.9)' : 'rgba(255, 77, 77, 0.9)'};
                color: ${type === 'success' ? '#000' : '#fff'};
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Expand all nodes
        function expandAll() {
            // In a real implementation, you would expand all tree nodes
            // For now, just regenerate the tree
            generateTreeVisualization();
        }
        
        // Zoom functions
        function zoomIn() {
            svg.transition().duration(300).call(
                zoom.scaleBy, 1.2
            );
        }
        
        function zoomOut() {
            svg.transition().duration(300).call(
                zoom.scaleBy, 0.8
            );
        }
        
        function resetZoom() {
            svg.transition().duration(300).call(
                zoom.transform, d3.zoomIdentity
            );
        }
        
        // Initialize on page load
        window.onload = function() {
            initFloatingNodes();
            
            // Check if wallet is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                setTimeout(() => {
                    connectWallet();
                }, 1000);
            }
            
            // Auto-refresh REMOVED - Only manual refresh now
        };
    </script>
</body>
</html>
