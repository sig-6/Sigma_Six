<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SIGMA SIX | PREMIUM CHART + HISTORY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- Chart.js core -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.min.js"></script>
    <!-- Chart.js Financial (CDN fix) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@2.0.0/dist/chartjs-chart-financial.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --primary-dark: #00ccaa;
            --primary-glow: rgba(0, 255, 204, 0.3);
            --secondary: #9d4edd;
            --secondary-dark: #7b2cbf;
            --secondary-glow: rgba(157, 78, 221, 0.3);
            --accent: #ff2a6d;
            --accent-glow: rgba(255, 42, 109, 0.3);
            --bg: #0a0b10;
            --bg-light: #161821;
            --card: rgba(22, 24, 33, 0.8);
            --card-hover: rgba(32, 34, 43, 0.9);
            --text: #ffffff;
            --text-muted: #888;
            --border: #2d2f3e;
            --border-light: rgba(45, 47, 62, 0.5);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px var(--primary-glow);
            --blur: blur(12px);
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
            
            --candle-up: #00ff88;
            --candle-down: #ff4d4d;
            --candle-border-up: #00cc66;
            --candle-border-down: #cc0000;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.6;
        }
        
        .crypto-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(0, 255, 204, 0.1) 49px,
                    rgba(0, 255, 204, 0.1) 50px),
                repeating-linear-gradient(0deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(157, 78, 221, 0.1) 49px,
                    rgba(157, 78, 221, 0.1) 50px);
            animation: gridMove 20s linear infinite;
        }
        
        .crypto-bg::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(45deg, 
                    transparent 0px, 
                    transparent 69px,
                    rgba(255, 42, 109, 0.08) 69px,
                    rgba(255, 42, 109, 0.08) 70px),
                repeating-linear-gradient(-45deg, 
                    transparent 0px, 
                    transparent 89px,
                    rgba(0, 255, 204, 0.08) 89px,
                    rgba(0, 255, 204, 0.08) 90px);
            animation: diagonalMove 15s linear infinite reverse;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 50px) rotate(0.5deg); }
        }
        
        @keyframes diagonalMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-70px, -70px) rotate(-0.5deg); }
        }
        
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.2;
            box-shadow: 0 0 10px var(--primary);
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.2) 0%, rgba(0,255,204,0.15) 25%, transparent 70%);
            border-radius: 50%;
            z-index: -2;
            animation: pulse 8s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .ticker-container {
            background: rgba(10, 11, 16, 0.9);
            backdrop-filter: var(--blur);
            border-bottom: 1px solid var(--border-light);
            padding: 8px 0;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }
        
        .ticker-wrapper {
            display: flex;
            width: max-content;
            animation: ticker 40s linear infinite;
        }
        
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .ticker-item {
            display: flex;
            align-items: center;
            margin: 0 25px;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .ticker-symbol {
            font-weight: 700;
            color: var(--primary);
            margin-right: 8px;
        }
        
        .positive { color: var(--success); background: rgba(0, 255, 136, 0.1); }
        .negative { color: var(--danger); background: rgba(255, 77, 77, 0.1); }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient);
            color: #000;
            border: none;
            border-radius: 40px;
            padding: 12px 28px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px var(--primary-glow);
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--primary-glow);
        }
        
        .connect-btn.connected {
            background: rgba(0, 255, 204, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 90px 20px 30px;
            position: relative;
            z-index: 1;
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(0, 255, 204, 0.08);
            border: 1px solid rgba(0, 255, 204, 0.2);
            backdrop-filter: var(--blur);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .back-btn:hover {
            background: rgba(0, 255, 204, 0.15);
            border-color: var(--primary);
            transform: translateX(-5px);
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: var(--blur);
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(0, 255, 204, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: clamp(32px, 6vw, 52px);
            font-weight: 800;
            margin-bottom: 8px;
            animation: rainbow 8s ease infinite;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: clamp(14px, 4vw, 16px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .event-badge {
            background: rgba(255, 170, 0, 0.15);
            color: var(--warning);
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }
        
        .live-price-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-xl);
            padding: clamp(20px, 4vw, 30px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .live-price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            animation: rainbow 8s ease infinite;
        }
        
        .live-price-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }
        
        .live-price-value {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            color: var(--primary);
        }
        
        .live-price-inr {
            font-size: clamp(16px, 3vw, 20px);
            color: var(--warning);
            background: rgba(255, 170, 0, 0.1);
            padding: 4px 12px;
            border-radius: 30px;
        }
        
        .next-update {
            background: rgba(255, 170, 0, 0.08);
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid rgba(255, 170, 0, 0.2);
            font-size: 14px;
        }
        
        .next-update i { color: var(--warning); margin-right: 8px; }
        .next-update span { color: var(--warning); font-weight: 600; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 992px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
        
        .stat-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px var(--primary-glow);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient);
            animation: rainbow 8s ease infinite;
            opacity: 0.5;
        }
        
        .stat-icon {
            width: 45px;
            height: 45px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .stat-icon i { font-size: 22px; color: var(--secondary); }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .stat-number {
            font-size: clamp(18px, 3vw, 22px);
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .stat-inr {
            font-size: 14px;
            color: var(--warning);
            margin-top: 5px;
            font-weight: 600;
        }
        
        .stat-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-muted);
        }
        
        .chart-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            animation: rainbow 8s ease infinite;
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .chart-title {
            color: var(--primary);
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-legend {
            display: flex;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-up {
            width: 16px;
            height: 16px;
            background: var(--candle-up);
            border: 1px solid var(--candle-border-up);
        }
        
        .legend-down {
            width: 16px;
            height: 16px;
            background: var(--candle-down);
            border: 1px solid var(--candle-border-down);
        }
        
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: 15px;
        }
        
        .chart-timeframes {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .timeframe-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .timeframe-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        .history-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-xl);
            padding: 25px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
        }
        
        .history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            animation: rainbow 8s ease infinite;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        .results-count {
            background: rgba(0, 255, 204, 0.08);
            color: var(--primary);
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0, 255, 204, 0.2);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border-light);
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0, 255, 204, 0.1), rgba(157, 78, 221, 0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0, 255, 204, 0.2);
        }
        
        td {
            padding: 14px 15px;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
        }
        
        .rate-cell { color: var(--primary); font-weight: 700; }
        .inr-cell { color: var(--warning); }
        
        .badge-new {
            background: var(--success);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 700;
        }
        
        .tx-badge {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .load-more {
            text-align: center;
            margin-top: 25px;
        }
        
        .load-more-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 12px 35px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: rgba(0, 255, 204, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 204, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            backdrop-filter: var(--blur);
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            font-size: 13px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb {
            background: var(--gradient);
            border-radius: 4px;
            animation: rainbow 8s ease infinite;
        }
        
        @media (max-width: 768px) {
            .connect-btn { padding: 8px 16px; font-size: 12px; }
            .chart-container { height: 300px; }
            .filter-btn { flex: 1; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="crypto-bg"></div>
    <div class="particles" id="particles"></div>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <div class="ticker-container">
        <div class="ticker-wrapper" id="tickerWrapper"></div>
    </div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <button class="nav-btn" onclick="loadPriceHistory()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportCSV()"><i class="fas fa-download"></i> CSV</button>
        </div>
        
        <div class="header">
            <h1>SIGMA CHARTS & HISTORY</h1>
            <p>
                <i class="fas fa-bolt" style="color: var(--warning);"></i>
                Professional candlestick chart
                <span class="event-badge"><i class="fas fa-chart-line"></i> LIVE</span>
            </p>
        </div>
        
        <div class="live-price-card">
            <div class="live-price-info">
                <div class="pulse-dot"></div>
                <span class="live-price-value" id="liveRate">--</span>
                <span class="live-price-inr" id="liveRateInr">--</span>
            </div>
            <div class="next-update">
                <i class="fas fa-clock"></i>
                <span>Updates every 10s</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-label">ALL TIME HIGH</div>
                <div class="stat-number" id="ath">--</div>
                <div class="stat-inr" id="athInr">--</div>
                <div class="stat-trend" id="athDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                <div class="stat-label">ALL TIME LOW</div>
                <div class="stat-number" id="atl">--</div>
                <div class="stat-inr" id="atlInr">--</div>
                <div class="stat-trend" id="atlDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-label">30D AVG</div>
                <div class="stat-number" id="avg30">--</div>
                <div class="stat-inr" id="avg30Inr">--</div>
                <div class="stat-trend"><span id="avg30Change">--</span></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-label">TRADING DAYS</div>
                <div class="stat-number" id="totalRecords">--</div>
                <div class="stat-trend"><span id="daysTracked">-- days</span></div>
            </div>
        </div>
        
        <!-- CANDLESTICK CHART -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i> SIG6/USDT · Candlestick
                </div>
                <div class="chart-legend">
                    <div class="legend-item"><div class="legend-up"></div><span>Bullish</span></div>
                    <div class="legend-item"><div class="legend-down"></div><span>Bearish</span></div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="candlestickChart"></canvas>
            </div>
            
            <div class="chart-timeframes">
                <button class="timeframe-btn active" onclick="changeTimeframe('all')">ALL</button>
                <button class="timeframe-btn" onclick="changeTimeframe('30')">30D</button>
                <button class="timeframe-btn" onclick="changeTimeframe('7')">7D</button>
                <button class="timeframe-btn" onclick="changeTimeframe('1')">24H</button>
            </div>
        </div>
        
        <!-- HISTORY TABLE -->
        <div class="history-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-table"></i> DAILY RATES
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterHistory('all')">ALL</button>
                    <button class="filter-btn" onclick="filterHistory('30')">30D</button>
                    <button class="filter-btn" onclick="filterHistory('7')">7D</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-chart-line"></i> <span id="results-text">0 days</span>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>DATE</th>
                            <th>OPEN</th>
                            <th>HIGH</th>
                            <th>LOW</th>
                            <th>CLOSE</th>
                            <th>INR</th>
                            <th>VOLUME</th>
                        </tr>
                    </thead>
                    <tbody id="price-body">
                        <tr><td colspan="8" class="loading">
                            <div class="spinner"></div>
                            Connect wallet to view data
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="load-more" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" onclick="loadMore()">LOAD MORE</button>
            </div>
            
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV()"><i class="fas fa-file-csv"></i> EXPORT CSV</button>
                <button class="export-btn" onclick="loadPriceHistory()"><i class="fas fa-sync-alt"></i> REFRESH</button>
            </div>
        </div>
    </div>
    
    <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
    </div>

    <script>
        const SIGMA_ADDRESS = "0x068Aaba73Fd754F21140E2F13DA177ce7251A299";
        
        const SIGMA_ABI = [
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function ath() view returns (uint256)",
            "function atl() view returns (uint256)",
            "event Bought(address indexed user, uint256 usdtAmount, uint256 sigmaAmount, uint256 rate, uint256 timestamp)",
            "event Sold(address indexed user, uint256 sigmaAmount, uint256 usdtAmount, uint256 rate, uint256 timestamp)"
        ];

        let provider, userAddress, sigmaContract;
        let isConnected = false;
        let priceHistory = [];
        let currentFilter = 'all';
        let displayedRecords = 20;
        let currentRate = 0;
        let chart = null;
        const INR_RATE = 95;

        window.onload = async () => {
            createParticles();
            setupTicker();
            
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                try {
                    const accounts = await provider.send("eth_accounts", []);
                    if (accounts?.length) await connectWallet(true);
                } catch (e) {}
            }
        };

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 10 + 's';
                p.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(p);
            }
        }

        function setupTicker() {
            const wrapper = document.getElementById('tickerWrapper');
            const symbols = ['BTC', 'ETH', 'BNB', 'SOL', 'ADA', 'DOT', 'MATIC', 'LINK'];
            wrapper.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const symbol = symbols[i % 8];
                const price = (Math.random() * 1000 + 100).toFixed(2);
                const change = (Math.random() * 10 - 5).toFixed(2);
                const cls = parseFloat(change) >= 0 ? 'positive' : 'negative';
                wrapper.innerHTML += `<div class="ticker-item"><span class="ticker-symbol">${symbol}</span><span>$${price}</span><span class="ticker-change ${cls}">${change}%</span></div>`;
            }
        }

        async function connectWallet(silent = false) {
            if (!window.ethereum) {
                if (!silent) alert("Please install MetaMask!");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    if (!silent) alert("Please switch to Polygon Mainnet");
                    return;
                }
                
                sigmaContract = new ethers.Contract(SIGMA_ADDRESS, SIGMA_ABI, provider);
                isConnected = true;
                
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Connected';
                
                await loadPriceHistory();
                setInterval(updateLiveRate, 10000);
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => location.reload());
                
            } catch (error) {
                console.error(error);
                if (!silent) alert("Connection failed");
            }
        }

        async function handleAccountsChanged(accounts) {
            if (accounts?.length) {
                userAddress = accounts[0].toLowerCase();
                await loadPriceHistory();
            } else {
                isConnected = false;
                document.getElementById('connectBtn').classList.remove('connected');
                document.getElementById('btn-text').textContent = 'Connect Wallet';
                document.getElementById('statusDot').className = '';
                document.getElementById('statusText').textContent = 'Disconnected';
            }
        }

        async function loadPriceHistory() {
            if (!isConnected || !sigmaContract) {
                document.getElementById('price-body').innerHTML = `<tr><td colspan="8" class="loading"><div class="spinner"></div>Connect wallet</td></tr>`;
                return;
            }
            
            try {
                document.getElementById('price-body').innerHTML = `<tr><td colspan="8" class="loading"><div class="spinner"></div>Fetching data...</td></tr>`;
                
                // Current rate
                const rateBN = await sigmaContract.currentRate();
                currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                document.getElementById('liveRateInr').textContent = '₹' + (currentRate * INR_RATE).toFixed(2);
                
                // ATH & ATL
                const ath = await sigmaContract.ath();
                const atl = await sigmaContract.atl();
                const athVal = parseFloat(ethers.formatUnits(ath, 6));
                const atlVal = parseFloat(ethers.formatUnits(atl, 6));
                
                document.getElementById('ath').textContent = athVal.toFixed(6) + ' USDT';
                document.getElementById('athInr').textContent = '₹' + (athVal * INR_RATE).toFixed(2);
                document.getElementById('atl').textContent = atlVal.toFixed(6) + ' USDT';
                document.getElementById('atlInr').textContent = '₹' + (atlVal * INR_RATE).toFixed(2);
                
                // Fetch events
                const bought = await sigmaContract.queryFilter(sigmaContract.filters.Bought(), 0, 'latest');
                const sold = await sigmaContract.queryFilter(sigmaContract.filters.Sold(), 0, 'latest');
                
                // Group by date
                const daily = {};
                
                [...bought, ...sold].forEach(event => {
                    const ts = event.args.timestamp.toNumber() * 1000;
                    const rate = parseFloat(ethers.formatUnits(event.args.rate, 6));
                    const amount = event.args.usdtAmount ? 
                        parseFloat(ethers.formatUnits(event.args.usdtAmount, 6)) : 
                        parseFloat(ethers.formatUnits(event.args.sigmaAmount, 18)) * rate;
                    
                    const date = new Date(ts).toISOString().split('T')[0];
                    
                    if (!daily[date]) {
                        daily[date] = { open: rate, high: rate, low: rate, close: rate, volume: amount, ts };
                    } else {
                        daily[date].high = Math.max(daily[date].high, rate);
                        daily[date].low = Math.min(daily[date].low, rate);
                        daily[date].close = rate;
                        daily[date].volume += amount;
                    }
                });
                
                // Build history array
                priceHistory = Object.entries(daily).map(([date, d]) => ({
                    date,
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    close: d.close,
                    volume: d.volume,
                    timestamp: d.ts,
                    inr: d.close * INR_RATE
                })).sort((a, b) => a.timestamp - b.timestamp);
                
                // Add today if no transaction
                const today = new Date().toISOString().split('T')[0];
                if (!priceHistory.find(d => d.date === today) && priceHistory.length) {
                    const last = priceHistory[priceHistory.length - 1].close;
                    priceHistory.push({
                        date: today,
                        open: last,
                        high: Math.max(last, currentRate),
                        low: Math.min(last, currentRate),
                        close: currentRate,
                        volume: 0,
                        timestamp: Date.now(),
                        inr: currentRate * INR_RATE
                    });
                }
                
                if (!priceHistory.length) {
                    document.getElementById('price-body').innerHTML = `<tr><td colspan="8" class="empty-state">No data</td></tr>`;
                    return;
                }
                
                // Update ATH/ATL dates
                const rates = priceHistory.map(d => d.close);
                const athIdx = rates.indexOf(Math.max(...rates));
                const atlIdx = rates.indexOf(Math.min(...rates));
                
                if (athIdx >= 0) document.getElementById('athDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(priceHistory[athIdx].date).toLocaleDateString()}`;
                if (atlIdx >= 0) document.getElementById('atlDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(priceHistory[atlIdx].date).toLocaleDateString()}`;
                
                // 30D avg
                const last30 = priceHistory.slice(-30);
                const avg30 = last30.reduce((s, i) => s + i.close, 0) / last30.length;
                document.getElementById('avg30').textContent = avg30.toFixed(6) + ' USDT';
                document.getElementById('avg30Inr').textContent = '₹' + (avg30 * INR_RATE).toFixed(2);
                
                if (last30.length >= 2) {
                    const first = last30[0].close;
                    const last = last30[last30.length - 1].close;
                    document.getElementById('avg30Change').textContent = ((last - first) / first * 100).toFixed(2) + '%';
                }
                
                document.getElementById('totalRecords').textContent = priceHistory.length;
                document.getElementById('daysTracked').textContent = priceHistory.length + ' days';
                
                renderTable();
                renderChart('all');
                
            } catch (error) {
                console.error(error);
                document.getElementById('price-body').innerHTML = `<tr><td colspan="8" class="empty-state">Error: ${error.message}</td></tr>`;
            }
        }

        function renderChart(timeframe) {
            let data = [...priceHistory];
            if (timeframe === '30') data = data.slice(-30);
            else if (timeframe === '7') data = data.slice(-7);
            else if (timeframe === '1') data = data.slice(-1);
            
            if (!data.length) return;
            
            const ctx = document.getElementById('candlestickChart').getContext('2d');
            if (chart) chart.destroy();
            
            // Check if Chart is registered with candlestick
            if (!Chart.registry.controllers.get('candlestick')) {
                console.log("Candlestick not available, using line chart fallback");
                // Fallback to line chart
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Close Price',
                            data: data.map(d => d.close),
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(0,255,204,0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { ticks: { callback: v => v.toFixed(6) } } }
                    }
                });
                return;
            }
            
            // Use candlestick if available
            chart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'SIG6/USDT',
                        data: data.map(d => ({
                            x: new Date(d.date).getTime(),
                            o: d.open,
                            h: d.high,
                            l: d.low,
                            c: d.close
                        })),
                        borderColor: (ctx) => {
                            const d = ctx.dataset.data[ctx.dataIndex];
                            return d.c >= d.o ? 'var(--candle-border-up)' : 'var(--candle-border-down)';
                        },
                        backgroundColor: (ctx) => {
                            const d = ctx.dataset.data[ctx.dataIndex];
                            return d.c >= d.o ? 'var(--candle-up)' : 'var(--candle-down)';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const d = ctx.raw;
                                    return [
                                        `O: ${d.o.toFixed(6)}`,
                                        `H: ${d.h.toFixed(6)}`,
                                        `L: ${d.l.toFixed(6)}`,
                                        `C: ${d.c.toFixed(6)}`,
                                        `INR: ₹${(d.c * INR_RATE).toFixed(2)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'day' } },
                        y: { ticks: { callback: v => v.toFixed(6) } }
                    }
                }
            });
        }

        function changeTimeframe(tf) {
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderChart(tf);
        }

        function renderTable() {
            const tbody = document.getElementById('price-body');
            let filtered = [...priceHistory].reverse(); // newest first
            
            if (currentFilter === '30') filtered = filtered.slice(0, 30);
            else if (currentFilter === '7') filtered = filtered.slice(0, 7);
            
            const display = filtered.slice(0, displayedRecords);
            
            if (!display.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No records</td></tr>`;
                document.getElementById('results-count').style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('results-count').style.display = 'inline-block';
            document.getElementById('results-text').textContent = `${filtered.length} days (showing ${display.length})`;
            
            let html = '';
            display.forEach((item, i) => {
                const date = new Date(item.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                const isToday = item.date === new Date().toISOString().split('T')[0];
                
                html += `<tr>
                    <td>#${priceHistory.length - i}</td>
                    <td>${date}${isToday ? '<span class="badge-new">LIVE</span>' : ''}</td>
                    <td class="rate-cell">${item.open.toFixed(6)}</td>
                    <td class="rate-cell">${item.high.toFixed(6)}</td>
                    <td class="rate-cell">${item.low.toFixed(6)}</td>
                    <td class="rate-cell">${item.close.toFixed(6)}</td>
                    <td class="inr-cell">₹${item.inr.toFixed(2)}</td>
                    <td>${item.volume.toFixed(2)}</td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            document.getElementById('loadMoreContainer').style.display = displayedRecords < filtered.length ? 'block' : 'none';
        }

        async function updateLiveRate() {
            if (isConnected && sigmaContract) {
                try {
                    const rateBN = await sigmaContract.currentRate();
                    currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                    document.getElementById('liveRateInr').textContent = '₹' + (currentRate * INR_RATE).toFixed(2);
                } catch (e) {}
            }
        }

        function filterHistory(filter) {
            currentFilter = filter;
            displayedRecords = 20;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderTable();
        }

        function loadMore() {
            displayedRecords += 20;
            renderTable();
        }

        function exportCSV() {
            if (!priceHistory.length) return alert("No data");
            let csv = "Date,Open,High,Low,Close,INR,Volume\n";
            priceHistory.forEach(d => csv += `${d.date},${d.open.toFixed(6)},${d.high.toFixed(6)},${d.low.toFixed(6)},${d.close.toFixed(6)},${d.inr.toFixed(2)},${d.volume.toFixed(2)}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sigma_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
