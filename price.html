<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | PRICE HISTORY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== ROOT & BACKGROUND ========== */
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            min-height: 100vh; overflow-x: hidden; position: relative;
        }
        
        /* ===== ENHANCED CRYPTO PREMIUM CRISS-CROSS BACKGROUND ===== */
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.5;
        }
        
        .crypto-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(0, 255, 204, 0.15) 49px,
                    rgba(0, 255, 204, 0.15) 50px),
                repeating-linear-gradient(0deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(157, 78, 221, 0.15) 49px,
                    rgba(157, 78, 221, 0.15) 50px);
            animation: gridMove 20s linear infinite;
        }
        
        .crypto-bg::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(45deg, 
                    transparent 0px, 
                    transparent 69px,
                    rgba(255, 42, 109, 0.1) 69px,
                    rgba(255, 42, 109, 0.1) 70px),
                repeating-linear-gradient(-45deg, 
                    transparent 0px, 
                    transparent 89px,
                    rgba(0, 255, 204, 0.1) 89px,
                    rgba(0, 255, 204, 0.1) 90px);
            animation: diagonalMove 15s linear infinite reverse;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 50px) rotate(0.5deg); }
        }
        
        @keyframes diagonalMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-70px, -70px) rotate(-0.5deg); }
        }
        
        .crypto-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.3;
            box-shadow: 0 0 10px var(--primary);
            animation: particleFloat 15s infinite linear;
        }
        
        .particle:nth-child(3n) {
            background: var(--secondary);
            box-shadow: 0 0 10px var(--secondary);
        }
        
        .particle:nth-child(5n) {
            background: #ff2a6d;
            box-shadow: 0 0 10px #ff2a6d;
        }
        
        @keyframes particleFloat {
            0% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            25% { transform: translate(100px, -100px) scale(1.5); opacity: 0.6; }
            50% { transform: translate(200px, 0) scale(1); opacity: 0.3; }
            75% { transform: translate(100px, 100px) scale(0.8); opacity: 0.6; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
        }
        
        .rainbow-border { position:fixed; top:0; left:0; width:100%; height:4px; background:var(--gradient); background-size:400% 400%; animation:rainbow 8s ease infinite; z-index:1000; }
        .rainbow-glow { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:800px; height:800px; background:radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, rgba(0,11,16,0) 70%); border-radius:50%; z-index:-1; animation:pulse 6s ease-in-out infinite alternate; }
        
        @keyframes rainbow { 0% { background-position:0% 50%; } 50% { background-position:100% 50%; } 100% { background-position:0% 50%; } }
        @keyframes pulse { 0% { opacity:0.5; transform:translate(-50%,-50%) scale(0.9); } 100% { opacity:0.8; transform:translate(-50%,-50%) scale(1.1); } }
        
        .ticker-container { background:rgba(10,11,16,0.9); backdrop-filter:blur(10px); border-bottom:1px solid rgba(0,255,204,0.2); padding:10px 0; overflow:hidden; position:relative; z-index:10; }
        .ticker-wrapper { display:flex; width:max-content; animation:ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform:translateX(0); } 100% { transform:translateX(-50%); } }
        .ticker-item { display:flex; align-items:center; margin:0 30px; white-space:nowrap; }
        .ticker-symbol { font-weight:700; font-size:14px; color:var(--primary); margin-right:8px; }
        .ticker-price { font-weight:600; font-size:14px; }
        .ticker-change { font-weight:600; font-size:12px; margin-left:8px; padding:2px 6px; border-radius:4px; }
        .positive { color:var(--success); background:rgba(0,255,136,0.1); }
        .negative { color:var(--danger); background:rgba(255,77,77,0.1); }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header with back button */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 12px 25px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .back-btn:hover {
            background: var(--primary);
            color: #000;
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(0,255,204,0.3);
        }
        
        .page-title {
            text-align: center;
            flex: 1;
        }
        
        .page-title h1 {
            background: var(--gradient);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 42px;
            font-weight: 800;
            letter-spacing: 2px;
            margin-bottom: 8px;
            animation: rainbow 8s ease infinite;
        }
        
        .page-title p {
            color: #aaa;
            font-size: 14px;
            letter-spacing: 1px;
        }
        
        /* Live Price Card */
        .live-price-card {
            background: rgba(22,24,33,0.8);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(0,255,204,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .live-price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .live-price-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .live-price-text {
            font-size: 18px;
            color: #aaa;
        }
        
        .live-price-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-left: 15px;
        }
        
        .live-price-inr {
            font-size: 18px;
            color: #ffaa00;
            margin-left: 15px;
        }
        
        .next-update {
            background: rgba(255,170,0,0.1);
            padding: 12px 25px;
            border-radius: 40px;
            border: 1px solid var(--warning);
        }
        
        .next-update i {
            color: var(--warning);
            margin-right: 8px;
        }
        
        .next-update span {
            color: var(--warning);
            font-weight: 600;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: rgba(22,24,33,0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(157,78,221,0.2);
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(157,78,221,0.2);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            background: rgba(157,78,221,0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .stat-icon i {
            font-size: 24px;
            color: var(--secondary);
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .stat-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        
        /* Price History Table */
        .history-card {
            background: rgba(22,24,33,0.8);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(0,255,204,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        
        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .history-header h2 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            color: #aaa;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 18px 15px;
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--primary);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 15px;
        }
        
        tr:hover td {
            background: rgba(0,255,204,0.02);
        }
        
        .sl-no {
            color: #888;
            font-weight: 600;
        }
        
        .date-cell {
            font-weight: 600;
        }
        
        .rate-cell {
            color: var(--primary);
            font-weight: 700;
            font-size: 16px;
        }
        
        .inr-cell {
            color: #ffaa00;
            font-size: 14px;
        }
        
        .change-cell {
            font-weight: 600;
        }
        
        .badge-new {
            background: var(--success);
            color: #000;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 700;
        }
        
        .load-more {
            text-align: center;
            margin-top: 25px;
        }
        
        .load-more-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .load-more-btn:hover {
            background: var(--secondary);
            color: #000;
        }
        
        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .export-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            color: #aaa;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(22,24,33,0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #888;
        }
        
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        /* Loading spinner */
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0,255,204,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="crypto-bg"></div>
    <div class="crypto-particles" id="cryptoParticles"></div>
    <div class="rainbow-border"></div>
    <div class="rainbow-glow"></div>
    
    <div class="ticker-container">
        <div class="ticker-wrapper" id="tickerWrapper"></div>
    </div>
    
    <div class="container">
        <!-- Header with back button -->
        <div class="page-header">
            <button class="back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> BACK
            </button>
            <div class="page-title">
                <h1>PRICE HISTORY</h1>
                <p>Daily snapshots at 23:59 • Premium tracking</p>
            </div>
            <div style="width: 100px;"></div> <!-- Spacer for balance -->
        </div>
        
        <!-- Live Price Card -->
        <div class="live-price-card">
            <div class="live-price-info">
                <div class="pulse-dot"></div>
                <span class="live-price-text">LIVE RATE</span>
                <span class="live-price-value" id="liveRate">--</span>
                <span class="live-price-inr" id="liveRateInr">--</span>
            </div>
            <div class="next-update">
                <i class="fas fa-clock"></i>
                <span id="nextUpdate">Next snapshot: 23:59</span>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-label">ALL TIME HIGH</div>
                <div class="stat-number" id="ath">--</div>
                <div class="stat-trend trend-up" id="athDate">
                    <i class="fas fa-calendar"></i> --
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="stat-label">ALL TIME LOW</div>
                <div class="stat-number" id="atl">--</div>
                <div class="stat-trend trend-down" id="atlDate">
                    <i class="fas fa-calendar"></i> --
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-label">AVERAGE (30D)</div>
                <div class="stat-number" id="avg30">--</div>
                <div class="stat-trend">
                    <i class="fas fa-percent"></i> <span id="avg30Change">--</span>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-label">RECORDS</div>
                <div class="stat-number" id="totalRecords">--</div>
                <div class="stat-trend">
                    <i class="fas fa-history"></i> <span id="daysTracked">-- days</span>
                </div>
            </div>
        </div>
        
        <!-- Price History Table -->
        <div class="history-card">
            <div class="history-header">
                <h2>
                    <i class="fas fa-table"></i> DAILY SNAPSHOTS
                </h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterHistory('all')">ALL</button>
                    <button class="filter-btn" onclick="filterHistory('30')">30 DAYS</button>
                    <button class="filter-btn" onclick="filterHistory('7')">7 DAYS</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="priceTable">
                    <thead>
                        <tr>
                            <th>Sl. No</th>
                            <th>Date</th>
                            <th>Rate (USDT)</th>
                            <th>≈ INR</th>
                            <th>24h Change</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                        <tr>
                            <td colspan="5" class="loading-spinner">
                                <div class="spinner"></div>
                                <div>Loading price history...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="load-more" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" onclick="loadMore()">
                    <i class="fas fa-history"></i> LOAD MORE
                </button>
            </div>
            
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> EXPORT CSV
                </button>
                <button class="export-btn" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i> EXPORT PDF
                </button>
                <button class="export-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> REFRESH
                </button>
            </div>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
        <button onclick="connectWallet()" style="background:var(--primary); border:none; color:#000; padding:5px 15px; border-radius:20px; font-weight:600; cursor:pointer; margin-left:10px;">
            CONNECT
        </button>
    </div>

    <script>
        // ========== CONTRACT CONFIGURATION ==========
        const SIGMA_ADDRESS = "0x068Aaba73Fd754F21140E2F13DA177ce7251A299";
        const USDT_ADDRESS = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
        
        // ABI (simplified for view functions)
        const SIGMA_ABI = [
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function ath() view returns (uint256)",
            "function atl() view returns (uint256)",
            "function dailyHistory(uint256) view returns (uint256 open, uint256 high, uint256 low, uint256 close, uint256 timestamp)",
            "function lastHistoryDay() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function users(address) view returns (address upline, uint256 referralExpiry, uint256 totalReferralEarned, uint256 lastBuyTimestamp, uint256 lastActionBlock, uint256 qualifiedDirectsCount, bool hasBought, bool isInitialized, bool isCurrentlyQualified)"
        ];

        const USDT_ABI = [
            "function balanceOf(address) view returns (uint256)"
        ];

        // State
        let provider, signer, userAddress;
        let sigmaContract, usdtContract;
        let isConnected = false;
        let priceHistory = [];
        let currentFilter = 'all';
        let displayedRecords = 20;
        const INR_RATE = 95;

        // Initialize
        window.onload = async () => {
            createParticles();
            setupTicker();
            
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_accounts", []);
                if (accounts.length > 0) {
                    await connectWallet(true); // silent connect
                }
            }
            
            // Load mock data initially (will be replaced with real data when connected)
            loadMockData();
            
            // Check every minute for new snapshot (23:59)
            setInterval(checkForNewSnapshot, 60000);
            
            // Update live rate every 10 seconds
            setInterval(updateLiveRate, 10000);
        };

        function createParticles() {
            const container = document.getElementById('cryptoParticles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                container.appendChild(p);
            }
        }

        function setupTicker() {
            const wrapper = document.getElementById('tickerWrapper');
            const symbols = ['BTC', 'ETH', 'BNB', 'SOL', 'ADA', 'DOT', 'MATIC', 'LINK'];
            wrapper.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const symbol = symbols[i % symbols.length];
                const price = (Math.random() * 1000 + 100).toFixed(2);
                const change = (Math.random() * 10 - 5).toFixed(2);
                const cls = parseFloat(change) >= 0 ? 'positive' : 'negative';
                wrapper.innerHTML += `
                    <div class="ticker-item">
                        <span class="ticker-symbol">${symbol}</span>
                        <span class="ticker-price">$${price}</span>
                        <span class="ticker-change ${cls}">${change}%</span>
                    </div>
                `;
            }
        }

        async function connectWallet(silent = false) {
            if (!window.ethereum) {
                if (!silent) alert("MetaMask not installed!");
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                if (!silent) {
                    await provider.send("eth_requestAccounts", []);
                }
                
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    if (!silent) alert("Please switch to Polygon Mainnet");
                    return;
                }
                
                const accounts = await provider.listAccounts();
                if (accounts.length === 0) return;
                
                userAddress = accounts[0].toLowerCase();
                signer = await provider.getSigner();
                
                sigmaContract = new ethers.Contract(SIGMA_ADDRESS, SIGMA_ABI, signer);
                usdtContract = new ethers.Contract(USDT_ADDRESS, USDT_ABI, signer);
                
                isConnected = true;
                
                // Update UI
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                
                // Load real data
                await loadRealData();
                
            } catch (error) {
                console.error("Connection error:", error);
                if (!silent) alert("Connection failed: " + error.message);
            }
        }

        // ========== LOAD REAL DATA FROM CONTRACT ==========
        async function loadRealData() {
            if (!isConnected || !sigmaContract) return;
            
            try {
                // Get current rate
                const rate = await sigmaContract.currentRate();
                const currentRate = parseFloat(ethers.formatUnits(rate, 6));
                document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                document.getElementById('liveRateInr').textContent = '≈ ₹' + (currentRate * INR_RATE).toFixed(2);
                
                // Get ATH and ATL
                const ath = await sigmaContract.ath();
                const atl = await sigmaContract.atl();
                document.getElementById('ath').textContent = ethers.formatUnits(ath, 6) + ' USDT';
                document.getElementById('atl').textContent = ethers.formatUnits(atl, 6) + ' USDT';
                
                // Get daily history
                const lastDay = await sigmaContract.lastHistoryDay();
                const history = [];
                
                for (let i = 0; i <= lastDay; i++) {
                    try {
                        const day = await sigmaContract.dailyHistory(i);
                        if (day.close > 0) {
                            history.push({
                                index: i,
                                close: ethers.formatUnits(day.close, 6),
                                timestamp: Number(day.timestamp)
                            });
                        }
                    } catch (e) {
                        console.log("No history for day", i);
                    }
                }
                
                // Sort by timestamp (newest first)
                history.sort((a, b) => b.timestamp - a.timestamp);
                priceHistory = history;
                
                // Update stats
                updateStats();
                
                // Render table
                renderTable();
                
                // Update ATH/ATL dates
                if (history.length > 0) {
                    const athRecord = history.reduce((max, item) => parseFloat(item.close) > parseFloat(max.close) ? item : max, history[0]);
                    const atlRecord = history.reduce((min, item) => parseFloat(item.close) < parseFloat(min.close) ? item : min, history[0]);
                    
                    document.getElementById('athDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(athRecord.timestamp * 1000).toLocaleDateString()}`;
                    document.getElementById('atlDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(atlRecord.timestamp * 1000).toLocaleDateString()}`;
                }
                
                document.getElementById('totalRecords').textContent = history.length;
                document.getElementById('daysTracked').textContent = history.length + ' days';
                
            } catch (error) {
                console.error("Error loading real data:", error);
                loadMockData(); // Fallback to mock data
            }
        }

        // ========== MOCK DATA FOR DEMO ==========
        function loadMockData() {
            // Generate mock daily data for the last 30 days
            const mockHistory = [];
            const today = new Date();
            today.setHours(23, 59, 0, 0);
            
            let baseRate = 0.0125; // Base rate in USDT
            
            for (let i = 30; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Random fluctuation
                const change = (Math.random() * 0.002) - 0.001;
                baseRate += change;
                if (baseRate < 0.008) baseRate = 0.008;
                if (baseRate > 0.018) baseRate = 0.018;
                
                mockHistory.push({
                    index: i,
                    close: baseRate.toFixed(6),
                    timestamp: Math.floor(date.getTime() / 1000)
                });
            }
            
            priceHistory = mockHistory;
            
            // Set live rate
            const lastRate = priceHistory[priceHistory.length - 1].close;
            document.getElementById('liveRate').textContent = lastRate + ' USDT';
            document.getElementById('liveRateInr').textContent = '≈ ₹' + (parseFloat(lastRate) * INR_RATE).toFixed(2);
            
            // Set ATH/ATL
            const rates = priceHistory.map(h => parseFloat(h.close));
            const ath = Math.max(...rates);
            const atl = Math.min(...rates);
            
            document.getElementById('ath').textContent = ath.toFixed(6) + ' USDT';
            document.getElementById('atl').textContent = atl.toFixed(6) + ' USDT';
            
            // Find ATH/ATL dates
            const athIndex = rates.indexOf(ath);
            const atlIndex = rates.indexOf(atl);
            
            if (athIndex >= 0) {
                document.getElementById('athDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(priceHistory[athIndex].timestamp * 1000).toLocaleDateString()}`;
            }
            if (atlIndex >= 0) {
                document.getElementById('atlDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(priceHistory[atlIndex].timestamp * 1000).toLocaleDateString()}`;
            }
            
            // Update stats
            updateStats();
            
            // Render table
            renderTable();
            
            document.getElementById('totalRecords').textContent = priceHistory.length;
            document.getElementById('daysTracked').textContent = priceHistory.length + ' days';
        }

        function updateStats() {
            if (priceHistory.length === 0) return;
            
            // Calculate 30-day average
            const last30 = priceHistory.slice(0, Math.min(30, priceHistory.length));
            const avg30 = last30.reduce((sum, item) => sum + parseFloat(item.close), 0) / last30.length;
            document.getElementById('avg30').textContent = avg30.toFixed(6) + ' USDT';
            
            // Calculate 30-day change
            if (last30.length >= 2) {
                const first = parseFloat(last30[last30.length - 1].close);
                const last = parseFloat(last30[0].close);
                const change = ((last - first) / first * 100).toFixed(2);
                document.getElementById('avg30Change').textContent = change + '%';
                document.getElementById('avg30Change').style.color = change >= 0 ? 'var(--success)' : 'var(--danger)';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            let filteredHistory = priceHistory;
            
            if (currentFilter === '30') {
                filteredHistory = priceHistory.slice(0, 30);
            } else if (currentFilter === '7') {
                filteredHistory = priceHistory.slice(0, 7);
            }
            
            const displayHistory = filteredHistory.slice(0, displayedRecords);
            
            if (displayHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 50px; color: #888;">
                            <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                            <br>No history data available
                        </td>
                    </tr>
                `;
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }
            
            let html = '';
            displayHistory.forEach((item, index) => {
                const date = new Date(item.timestamp * 1000);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) + ' 23:59';
                
                const rate = parseFloat(item.close);
                const prevRate = index < displayHistory.length - 1 ? parseFloat(displayHistory[index + 1].close) : rate;
                const change = ((rate - prevRate) / prevRate * 100).toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                // Check if this is today's snapshot
                const isToday = new Date().toDateString() === date.toDateString();
                
                html += `
                    <tr>
                        <td><span class="sl-no">#${priceHistory.length - item.index}</span></td>
                        <td class="date-cell">
                            ${formattedDate}
                            ${isToday ? '<span class="badge-new">LATEST</span>' : ''}
                        </td>
                        <td class="rate-cell">${rate.toFixed(6)} USDT</td>
                        <td class="inr-cell">₹${(rate * INR_RATE).toFixed(2)}</td>
                        <td class="change-cell ${changeClass}">
                            <i class="fas ${changeIcon}"></i> ${Math.abs(change)}%
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            // Show/hide load more button
            if (displayedRecords < filteredHistory.length) {
                document.getElementById('loadMoreContainer').style.display = 'block';
            } else {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }
        }

        async function updateLiveRate() {
            if (isConnected && sigmaContract) {
                try {
                    const rate = await sigmaContract.currentRate();
                    const currentRate = parseFloat(ethers.formatUnits(rate, 6));
                    document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                    document.getElementById('liveRateInr').textContent = '≈ ₹' + (currentRate * INR_RATE).toFixed(2);
                } catch (error) {
                    console.log("Error updating live rate:", error);
                }
            }
            
            // Update next snapshot countdown
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(23, 59, 0, 0);
            
            if (now > midnight) {
                midnight.setDate(midnight.getDate() + 1);
            }
            
            const diffMs = midnight - now;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('nextUpdate').innerHTML = 
                `<i class="fas fa-clock"></i> Next snapshot: ${diffHrs}h ${diffMins}m`;
        }

        function checkForNewSnapshot() {
            const now = new Date();
            // Check if it's 23:59
            if (now.getHours() === 23 && now.getMinutes() === 59) {
                // In a real app, you would fetch new data from contract
                // For demo, we'll add a mock new record
                if (Math.random() > 0.5) { // Simulate new record every other minute
                    loadRealData();
                }
            }
        }

        function filterHistory(filter) {
            currentFilter = filter;
            displayedRecords = 20;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderTable();
        }

        function loadMore() {
            displayedRecords += 20;
            renderTable();
        }

        function exportCSV() {
            let csv = "Sl.No,Date,Rate (USDT),INR,24h Change\n";
            
            priceHistory.forEach((item, index) => {
                const date = new Date(item.timestamp * 1000).toLocaleDateString();
                const rate = parseFloat(item.close);
                const prevRate = index < priceHistory.length - 1 ? parseFloat(priceHistory[index + 1].close) : rate;
                const change = ((rate - prevRate) / prevRate * 100).toFixed(2);
                
                csv += `${priceHistory.length - index},${date} 23:59,${rate.toFixed(6)},${(rate * INR_RATE).toFixed(2)},${change}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sigma_price_history.csv';
            a.click();
        }

        function exportPDF() {
            // For demo, just show alert
            alert('PDF export will be available in premium version');
        }

        function refreshData() {
            if (isConnected) {
                loadRealData();
            } else {
                loadMockData();
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
