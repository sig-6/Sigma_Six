<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SIGMA SIX | PREMIUM PRICE HISTORY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== CRYPTO PREMIUM VARIABLES ===== */
        :root {
            --primary: #00ffcc;
            --primary-dark: #00ccaa;
            --primary-glow: rgba(0, 255, 204, 0.3);
            --secondary: #9d4edd;
            --secondary-dark: #7b2cbf;
            --secondary-glow: rgba(157, 78, 221, 0.3);
            --accent: #ff2a6d;
            --accent-glow: rgba(255, 42, 109, 0.3);
            --bg: #0a0b10;
            --bg-light: #161821;
            --card: rgba(22, 24, 33, 0.8);
            --card-hover: rgba(32, 34, 43, 0.9);
            --text: #ffffff;
            --text-muted: #888;
            --border: #2d2f3e;
            --border-light: rgba(45, 47, 62, 0.5);
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
            --gradient-secondary: linear-gradient(135deg, #00ffcc, #9d4edd);
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px var(--primary-glow);
            --blur: blur(12px);
            --border-radius-sm: 12px;
            --border-radius-md: 16px;
            --border-radius-lg: 24px;
            --border-radius-xl: 32px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .crypto-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.6;
        }
        
        .crypto-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(0, 255, 204, 0.1) 49px,
                    rgba(0, 255, 204, 0.1) 50px),
                repeating-linear-gradient(0deg, 
                    transparent 0px, 
                    transparent 49px,
                    rgba(157, 78, 221, 0.1) 49px,
                    rgba(157, 78, 221, 0.1) 50px);
            animation: gridMove 20s linear infinite;
        }
        
        .crypto-bg::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                repeating-linear-gradient(45deg, 
                    transparent 0px, 
                    transparent 69px,
                    rgba(255, 42, 109, 0.08) 69px,
                    rgba(255, 42, 109, 0.08) 70px),
                repeating-linear-gradient(-45deg, 
                    transparent 0px, 
                    transparent 89px,
                    rgba(0, 255, 204, 0.08) 89px,
                    rgba(0, 255, 204, 0.08) 90px);
            animation: diagonalMove 15s linear infinite reverse;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 50px) rotate(0.5deg); }
        }
        
        @keyframes diagonalMove {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-70px, -70px) rotate(-0.5deg); }
        }
        
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.2;
            box-shadow: 0 0 10px var(--primary);
            animation: float 20s infinite linear;
        }
        
        .particle:nth-child(3n) {
            background: var(--secondary);
            box-shadow: 0 0 10px var(--secondary);
        }
        
        .particle:nth-child(5n) {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }
        
        @keyframes float {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
            box-shadow: var(--shadow-glow);
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.2) 0%, rgba(0,255,204,0.15) 25%, transparent 70%);
            border-radius: 50%;
            z-index: -2;
            animation: pulse 8s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
        }
        
        .ticker-container {
            background: rgba(10, 11, 16, 0.9);
            backdrop-filter: var(--blur);
            border-bottom: 1px solid var(--border-light);
            padding: 8px 0;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }
        
        .ticker-wrapper {
            display: flex;
            width: max-content;
            animation: ticker 40s linear infinite;
        }
        
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        .ticker-item {
            display: flex;
            align-items: center;
            margin: 0 25px;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .ticker-symbol {
            font-weight: 700;
            color: var(--primary);
            margin-right: 8px;
        }
        
        .ticker-price {
            font-weight: 600;
        }
        
        .ticker-change {
            font-size: 11px;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .positive {
            color: var(--success);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .negative {
            color: var(--danger);
            background: rgba(255, 77, 77, 0.1);
        }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient);
            background-size: 200% auto;
            color: #000;
            border: none;
            border-radius: 40px;
            padding: 12px 28px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px var(--primary-glow);
            z-index: 1001;
            transition: all 0.3s ease;
            backdrop-filter: var(--blur);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--primary-glow);
            background-position: right center;
        }
        
        .connect-btn.connected {
            background: rgba(0, 255, 204, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
            backdrop-filter: var(--blur);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 90px 20px 30px;
            position: relative;
            z-index: 1;
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(0, 255, 204, 0.08);
            border: 1px solid rgba(0, 255, 204, 0.2);
            backdrop-filter: var(--blur);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .back-btn:hover {
            background: rgba(0, 255, 204, 0.15);
            border-color: var(--primary);
            transform: translateX(-5px);
        }
        
        .nav-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: var(--blur);
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: rgba(0, 255, 204, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            background: var(--gradient);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: clamp(32px, 6vw, 52px);
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            animation: rainbow 8s ease infinite;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: clamp(14px, 4vw, 16px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .event-badge {
            background: rgba(255, 170, 0, 0.15);
            color: var(--warning);
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }
        
        .live-price-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-xl);
            padding: clamp(20px, 4vw, 30px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .live-price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .live-price-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }
        
        .live-price-text {
            font-size: clamp(16px, 3vw, 18px);
            color: var(--text-muted);
        }
        
        .live-price-value {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }
        
        .live-price-inr {
            font-size: clamp(16px, 3vw, 20px);
            color: var(--warning);
            font-weight: 600;
            background: rgba(255, 170, 0, 0.1);
            padding: 4px 12px;
            border-radius: 30px;
            border: 1px solid rgba(255, 170, 0, 0.2);
        }
        
        .next-update {
            background: rgba(255, 170, 0, 0.08);
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid rgba(255, 170, 0, 0.2);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .next-update i {
            color: var(--warning);
        }
        
        .next-update span {
            color: var(--warning);
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px var(--primary-glow);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            opacity: 0.5;
        }
        
        .stat-icon {
            width: 45px;
            height: 45px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .stat-icon i {
            font-size: 22px;
            color: var(--secondary);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .stat-number {
            font-size: clamp(18px, 3vw, 22px);
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .stat-inr {
            font-size: 14px;
            color: var(--warning);
            margin-top: 5px;
            font-weight: 600;
        }
        
        .stat-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-muted);
        }
        
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        
        .history-card {
            background: var(--card);
            backdrop-filter: var(--blur);
            border-radius: var(--border-radius-xl);
            padding: clamp(20px, 4vw, 25px);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: clamp(20px, 4vw, 24px);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .results-count {
            background: rgba(0, 255, 204, 0.08);
            color: var(--primary);
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0, 255, 204, 0.2);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-light);
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0, 255, 204, 0.1), rgba(157, 78, 221, 0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(0, 255, 204, 0.2);
            white-space: nowrap;
        }
        
        td {
            padding: 14px 15px;
            border-bottom: 1px solid var(--border-light);
            font-size: 14px;
        }
        
        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .sl-no {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 13px;
        }
        
        .date-cell {
            font-weight: 600;
            white-space: nowrap;
        }
        
        .rate-cell {
            color: var(--primary);
            font-weight: 700;
            font-size: 15px;
        }
        
        .inr-cell {
            color: var(--warning);
            font-size: 13px;
            font-weight: 600;
        }
        
        .change-cell {
            font-weight: 600;
            white-space: nowrap;
        }
        
        .badge-new {
            background: var(--success);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .badge-saved {
            background: var(--secondary);
            color: #fff;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 700;
        }
        
        .badge-missing {
            background: var(--warning);
            color: #000;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 700;
        }
        
        .badge-1158 {
            background: #ff2a6d;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 700;
        }
        
        .tx-badge {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .load-more {
            text-align: center;
            margin-top: 25px;
        }
        
        .load-more-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 12px 35px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .load-more-btn:hover {
            background: var(--secondary);
            border-color: var(--secondary);
            color: #000;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .export-btn {
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: rgba(0, 255, 204, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--secondary);
            opacity: 0.5;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 204, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            backdrop-filter: var(--blur);
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 100;
            font-size: 13px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        .status-dot.disconnected {
            background: var(--danger);
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card);
            backdrop-filter: var(--blur);
            border-left: 4px solid var(--primary);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-glow);
            z-index: 2000;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
            transform: translateX(400px);
            opacity: 0;
        }
        
        @keyframes slideIn {
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { transform: translateX(400px); opacity: 0; }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gradient);
            border-radius: 4px;
            animation: rainbow 8s ease infinite;
        }
        
        @media (max-width: 768px) {
            .connect-btn {
                top: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .container {
                padding: 70px 12px 20px;
            }
            
            .nav-container {
                gap: 8px;
            }
            
            .back-btn, .nav-btn {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .live-price-card {
                padding: 20px;
            }
            
            .live-price-value {
                font-size: 28px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                margin-bottom: 10px;
            }
            
            .stat-icon i {
                font-size: 18px;
            }
            
            .stat-number {
                font-size: 18px;
            }
            
            .card-title {
                font-size: 20px;
            }
            
            .filter-buttons {
                width: 100%;
            }
            
            .filter-btn {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            td {
                padding: 12px 10px;
                font-size: 13px;
            }
            
            .rate-cell {
                font-size: 14px;
            }
            
            .export-buttons {
                justify-content: center;
            }
            
            .export-btn {
                flex: 1;
                justify-content: center;
            }
            
            .connection-status {
                bottom: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                justify-content: center;
            }
            
            .notification {
                top: 70px;
                right: 10px;
                left: 10px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 28px;
            }
            
            .live-price-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .live-price-value {
                font-size: 24px;
            }
            
            .next-update {
                width: 100%;
                text-align: center;
            }
            
            .results-count {
                width: 100%;
                text-align: center;
            }
            
            .date-cell {
                font-size: 12px;
            }
            
            .badge-new, .badge-saved, .badge-missing, .badge-1158 {
                display: block;
                margin-left: 0;
                margin-top: 5px;
                width: fit-content;
            }
            
            .tx-badge {
                display: block;
                margin-left: 0;
                margin-top: 3px;
            }
        }
    </style>
</head>
<body>
    <!-- PREMIUM BACKGROUND -->
    <div class="crypto-bg"></div>
    <div class="particles" id="particles"></div>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    
    <!-- TICKER -->
    <div class="ticker-container">
        <div class="ticker-wrapper" id="tickerWrapper"></div>
    </div>
    
    <!-- CONNECT BUTTON -->
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <!-- NOTIFICATION CONTAINER -->
    <div id="notificationContainer"></div>
    
    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- NAVIGATION -->
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
            <button class="nav-btn" onclick="loadPriceHistory()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportCSV()"><i class="fas fa-download"></i> CSV</button>
            <button class="nav-btn" onclick="clearHistory()"><i class="fas fa-trash"></i> Clear Cache</button>
            <button class="nav-btn" onclick="fillMissingDays()"><i class="fas fa-calendar-plus"></i> Fill Missing</button>
        </div>
        
        <!-- HEADER -->
        <div class="header">
            <h1>SIGMA PRICE HISTORY</h1>
            <p>
                <i class="fas fa-bolt" style="color: var(--warning);"></i>
                Auto-saves every day at 11:58 PM
                <span class="event-badge"><i class="fas fa-clock"></i> 23:58</span>
            </p>
        </div>
        
        <!-- LIVE PRICE CARD -->
        <div class="live-price-card">
            <div class="live-price-info">
                <div class="pulse-dot"></div>
                <span class="live-price-text">LIVE RATE</span>
                <span class="live-price-value" id="liveRate">--</span>
                <span class="live-price-inr" id="liveRateInr">--</span>
            </div>
            <div class="next-update">
                <i class="fas fa-clock"></i>
                <span id="nextUpdate">Auto-saves at 11:58 PM</span>
            </div>
        </div>
        
        <!-- STATS GRID - WITH INR VALUES -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-label">ALL TIME HIGH</div>
                <div class="stat-number" id="ath">--</div>
                <div class="stat-inr" id="athInr">--</div>
                <div class="stat-trend trend-up" id="athDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                <div class="stat-label">ALL TIME LOW</div>
                <div class="stat-number" id="atl">--</div>
                <div class="stat-inr" id="atlInr">--</div>
                <div class="stat-trend trend-down" id="atlDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-label">30D AVG</div>
                <div class="stat-number" id="avg30">--</div>
                <div class="stat-inr" id="avg30Inr">--</div>
                <div class="stat-trend"><i class="fas fa-percent"></i> <span id="avg30Change">--</span></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-label">TRADING DAYS</div>
                <div class="stat-number" id="totalRecords">--</div>
                <div class="stat-trend"><i class="fas fa-history"></i> <span id="daysTracked">-- days</span></div>
            </div>
        </div>
        
        <!-- HISTORY CARD -->
        <div class="history-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-table"></i> DAILY RATES
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterHistory('all')">ALL</button>
                    <button class="filter-btn" onclick="filterHistory('30')">30D</button>
                    <button class="filter-btn" onclick="filterHistory('7')">7D</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-chart-line"></i> <span id="results-text">0 days</span>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>DATE</th>
                            <th>RATE (USDT)</th>
                            <th>INR</th>
                            <th>24H</th>
                        </tr>
                    </thead>
                    <tbody id="price-body">
                        <tr><td colspan="5" class="loading">
                            <div class="spinner"></div>
                            Connect wallet to view price history
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="load-more" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" onclick="loadMore()">
                    <i class="fas fa-history"></i> LOAD MORE
                </button>
            </div>
            
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> EXPORT CSV
                </button>
                <button class="export-btn" onclick="loadPriceHistory()">
                    <i class="fas fa-sync-alt"></i> REFRESH
                </button>
            </div>
        </div>
    </div>
    
    <!-- CONNECTION STATUS -->
    <div class="connection-status" id="connectionStatus">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
    </div>

    <script>
        // ========== CONTRACT CONFIG ==========
        const SIGMA_ADDRESS = "0x068Aaba73Fd754F21140E2F13DA177ce7251A299";
        
        const SIGMA_ABI = [
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function ath() view returns (uint256)",
            "function atl() view returns (uint256)",
            "event Bought(address indexed user, uint256 usdtAmount, uint256 sigmaAmount, uint256 rate, uint256 timestamp)",
            "event Sold(address indexed user, uint256 sigmaAmount, uint256 usdtAmount, uint256 rate, uint256 timestamp)"
        ];

        // ========== STATE ==========
        let provider, userAddress;
        let sigmaContract;
        let isConnected = false;
        let priceHistory = [];
        let currentFilter = 'all';
        let displayedRecords = 20;
        let currentRate = 0;
        const INR_RATE = 95;
        const STORAGE_KEY = 'sigma_price_history_1158';

        // ========== INIT ==========
        window.onload = async () => {
            createParticles();
            setupTicker();
            
            // Load saved history from localStorage
            loadSavedHistory();
            
            // Check for missing days and fill them
            await checkAndFillMissingDays();
            
            // Check if we need to save today's rate at 11:58 PM
            checkAndSave1158Rate();
            
            // Check every minute for 11:58 PM
            setInterval(checkAndSave1158Rate, 60000);
            
            // Update next save time display
            updateNextSaveTime();
            setInterval(updateNextSaveTime, 1000);
            
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                try {
                    const accounts = await provider.send("eth_accounts", []);
                    if (accounts && accounts.length > 0) {
                        await connectWallet(true);
                    }
                } catch (e) {}
            }
        };

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 10 + 's';
                p.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(p);
            }
        }

        function setupTicker() {
            const wrapper = document.getElementById('tickerWrapper');
            const symbols = ['BTC', 'ETH', 'BNB', 'SOL', 'ADA', 'DOT', 'MATIC', 'LINK'];
            wrapper.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const symbol = symbols[i % symbols.length];
                const price = (Math.random() * 1000 + 100).toFixed(2);
                const change = (Math.random() * 10 - 5).toFixed(2);
                const cls = parseFloat(change) >= 0 ? 'positive' : 'negative';
                wrapper.innerHTML += `
                    <div class="ticker-item">
                        <span class="ticker-symbol">${symbol}</span>
                        <span class="ticker-price">$${price}</span>
                        <span class="ticker-change ${cls}">${change}%</span>
                    </div>
                `;
            }
        }

        function updateNextSaveTime() {
            const now = new Date();
            const target = new Date(now);
            target.setHours(23, 58, 0, 0);
            
            if (now > target) {
                target.setDate(target.getDate() + 1);
            }
            
            const diffMs = target - now;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            document.getElementById('nextUpdate').innerHTML = 
                `‚è∞ Next save in: ${diffHrs}h ${diffMins}m ${diffSecs}s`;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-clock'}" 
                   style="color: ${type === 'success' ? 'var(--success)' : 'var(--primary)'}; margin-right: 10px;"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ========== SAVE HISTORY TO LOCALSTORAGE ==========
        function saveHistoryToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(priceHistory));
                console.log('History saved to localStorage');
            } catch (e) {
                console.error('Failed to save history:', e);
            }
        }

        function loadSavedHistory() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    priceHistory = JSON.parse(saved);
                    console.log('Loaded history from localStorage:', priceHistory.length, 'records');
                    
                    // Sort by date (newest first)
                    priceHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Update stats if we have data
                    if (priceHistory.length > 0) {
                        updateStatsFromHistory();
                    }
                }
            } catch (e) {
                console.error('Failed to load history:', e);
                priceHistory = [];
            }
        }

        // ========== CHECK AND SAVE 11:58 PM RATE ==========
        async function checkAndSave1158Rate() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentSecond = now.getSeconds();
            
            // Check if it's 11:58 PM (23:58) - within 30 seconds window
            if (currentHour === 23 && currentMinute === 58 && currentSecond < 30) {
                // Check if we already saved today's rate
                const today = now.toISOString().split('T')[0];
                const alreadySaved = priceHistory.some(item => item.date === today && item.savedAt === '23:58');
                
                if (!alreadySaved && currentRate > 0) {
                    // Save today's rate at 11:58 PM
                    const newRecord = {
                        date: today,
                        close: currentRate,
                        timestamp: now.getTime() / 1000,
                        txCount: 0,
                        isSaved: true,
                        savedAt: '23:58',
                        is1158: true
                    };
                    
                    // Remove any existing record for today (from other times)
                    priceHistory = priceHistory.filter(item => item.date !== today);
                    
                    // Add new record
                    priceHistory.unshift(newRecord);
                    
                    // Keep only last 365 days
                    if (priceHistory.length > 365) {
                        priceHistory = priceHistory.slice(0, 365);
                    }
                    
                    saveHistoryToStorage();
                    
                    // Update display
                    if (isConnected) {
                        renderTable();
                        updateStatsFromHistory();
                    }
                    
                    console.log('‚úÖ Auto-saved 11:58 PM rate for', today, '=', currentRate);
                    showNotification(`üìä Today's rate saved at 11:58 PM: ${currentRate.toFixed(6)} USDT`, 'success');
                }
            }
        }

        // ========== CHECK AND FILL MISSING DAYS ==========
        async function checkAndFillMissingDays() {
            if (priceHistory.length === 0) return;
            
            // Sort by date (oldest first for processing)
            const sortedHistory = [...priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const firstDate = new Date(sortedHistory[0].date);
            const today = new Date();
            
            // Set to start of day for comparison
            firstDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            
            const daysDiff = Math.floor((today - firstDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 1) return; // No missing days
            
            // Create a set of existing dates
            const existingDates = new Set(sortedHistory.map(item => item.date));
            
            let missingCount = 0;
            let filledCount = 0;
            
            // Check each day from first date to today
            for (let i = 0; i <= daysDiff; i++) {
                const checkDate = new Date(firstDate);
                checkDate.setDate(firstDate.getDate() + i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                if (!existingDates.has(dateStr)) {
                    missingCount++;
                    
                    // Try to find rate from closest available day
                    const prevDay = [...sortedHistory].reverse().find(item => new Date(item.date) < checkDate);
                    const nextDay = sortedHistory.find(item => new Date(item.date) > checkDate);
                    
                    let fillRate = currentRate || 0.285492; // Default rate if nothing available
                    
                    if (prevDay && nextDay) {
                        // Interpolate between prev and next
                        const prevDate = new Date(prevDay.date);
                        const nextDate = new Date(nextDay.date);
                        const totalDays = (nextDate - prevDate) / (1000 * 60 * 60 * 24);
                        const daysFromPrev = (checkDate - prevDate) / (1000 * 60 * 60 * 24);
                        const ratio = daysFromPrev / totalDays;
                        
                        fillRate = prevDay.close + (nextDay.close - prevDay.close) * ratio;
                    } else if (prevDay) {
                        fillRate = prevDay.close;
                    } else if (nextDay) {
                        fillRate = nextDay.close;
                    }
                    
                    // Add missing day
                    priceHistory.push({
                        date: dateStr,
                        close: fillRate,
                        timestamp: checkDate.getTime() / 1000,
                        txCount: 0,
                        isMissing: true,
                        filledFrom: prevDay ? prevDay.date : (nextDay ? nextDay.date : 'default')
                    });
                    
                    filledCount++;
                }
            }
            
            if (missingCount > 0) {
                console.log(`Found ${missingCount} missing days, filled ${filledCount} days`);
                
                // Sort again (newest first)
                priceHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Save to storage
                saveHistoryToStorage();
                
                // Update display
                renderTable();
                updateStatsFromHistory();
                
                showNotification(`üìÖ Filled ${filledCount} missing days`, 'info');
            }
        }

        // ========== UPDATE STATS FROM HISTORY ==========
        function updateStatsFromHistory() {
            if (priceHistory.length === 0) return;
            
            const rates = priceHistory.map(h => h.close);
            const athRate = Math.max(...rates);
            const atlRate = Math.min(...rates);
            
            const athRecord = priceHistory.find(h => h.close === athRate);
            const atlRecord = priceHistory.find(h => h.close === atlRate);
            
            document.getElementById('ath').textContent = athRate.toFixed(6) + ' USDT';
            document.getElementById('athInr').textContent = '‚Çπ' + (athRate * INR_RATE).toFixed(2);
            document.getElementById('atl').textContent = atlRate.toFixed(6) + ' USDT';
            document.getElementById('atlInr').textContent = '‚Çπ' + (atlRate * INR_RATE).toFixed(2);
            
            if (athRecord) {
                document.getElementById('athDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(athRecord.date).toLocaleDateString()}`;
            }
            if (atlRecord) {
                document.getElementById('atlDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(atlRecord.date).toLocaleDateString()}`;
            }
            
            // Update 30D average
            const last30 = priceHistory.slice(0, Math.min(30, priceHistory.length));
            const avg30Calc = last30.reduce((sum, item) => sum + item.close, 0) / last30.length;
            document.getElementById('avg30').textContent = avg30Calc.toFixed(6) + ' USDT';
            document.getElementById('avg30Inr').textContent = '‚Çπ' + (avg30Calc * INR_RATE).toFixed(2);
            
            if (last30.length >= 2) {
                const first = last30[last30.length - 1].close;
                const last = last30[0].close;
                const change = ((last - first) / first * 100).toFixed(2);
                document.getElementById('avg30Change').textContent = change + '%';
                document.getElementById('avg30Change').style.color = change >= 0 ? 'var(--success)' : 'var(--danger)';
            }
            
            document.getElementById('totalRecords').textContent = priceHistory.length;
            document.getElementById('daysTracked').textContent = priceHistory.length + ' days';
        }

        // ========== FILL MISSING DAYS MANUALLY ==========
        async function fillMissingDays() {
            await checkAndFillMissingDays();
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all saved history?')) {
                priceHistory = [];
                localStorage.removeItem(STORAGE_KEY);
                renderTable();
                showNotification('üóëÔ∏è History cleared!', 'info');
            }
        }

        // ========== CONNECT WALLET ==========
        async function connectWallet(silent = false) {
            if (!window.ethereum) {
                if (!silent) {
                    alert("Please install MetaMask!");
                    window.open("https://metamask.io/download/", "_blank");
                }
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                const accounts = await provider.send("eth_requestAccounts", []);
                userAddress = accounts[0].toLowerCase();
                
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    if (!silent) {
                        alert("Please switch to Polygon Mainnet");
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x89' }],
                            });
                        } catch (switchError) {}
                    }
                    return;
                }
                
                sigmaContract = new ethers.Contract(SIGMA_ADDRESS, SIGMA_ABI, provider);
                isConnected = true;
                
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Connected';
                
                await loadPriceHistory();
                
                setInterval(updateLiveRate, 10000);
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
            } catch (error) {
                console.error("Connection error:", error);
                if (!silent) alert("Connection failed: " + error.message);
            }
        }

        async function handleAccountsChanged(accounts) {
            if (accounts && accounts.length > 0) {
                userAddress = accounts[0].toLowerCase();
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('statusDot').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Connected';
                await loadPriceHistory();
            } else {
                isConnected = false;
                document.getElementById('connectBtn').classList.remove('connected');
                document.getElementById('btn-text').textContent = 'Connect Wallet';
                document.getElementById('statusDot').className = 'status-dot disconnected';
                document.getElementById('statusText').textContent = 'Disconnected';
            }
        }

        // ========== LOAD PRICE HISTORY FROM EVENTS ==========
        async function loadPriceHistory() {
            if (!isConnected || !sigmaContract) {
                // Show saved history even if not connected
                if (priceHistory.length > 0) {
                    renderTable();
                    updateStatsFromHistory();
                } else {
                    document.getElementById('price-body').innerHTML = `
                        <tr><td colspan="5" class="loading">
                            <div class="spinner"></div>
                            Connect wallet to view full history
                        </td></tr>
                    `;
                }
                return;
            }
            
            try {
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="loading">
                        <div class="spinner"></div>
                        Fetching blockchain events...
                    </td></tr>
                `;
                
                // Get current rate
                const rateBN = await sigmaContract.currentRate();
                currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                
                document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                document.getElementById('liveRateInr').textContent = '‚Çπ' + (currentRate * INR_RATE).toFixed(2);
                
                // Get ATH and ATL from contract
                const ath = await sigmaContract.ath();
                const atl = await sigmaContract.atl();
                const athVal = parseFloat(ethers.formatUnits(ath, 6));
                const atlVal = parseFloat(ethers.formatUnits(atl, 6));
                
                // Fetch events
                const boughtFilter = sigmaContract.filters.Bought();
                const boughtEvents = await sigmaContract.queryFilter(boughtFilter, 0, 'latest');
                
                const soldFilter = sigmaContract.filters.Sold();
                const soldEvents = await sigmaContract.queryFilter(soldFilter, 0, 'latest');
                
                // Process events into daily rates
                const dailyRates = {};
                
                [...boughtEvents, ...soldEvents].forEach(event => {
                    try {
                        const timestamp = event.args.timestamp.toNumber();
                        const rate = parseFloat(ethers.formatUnits(event.args.rate, 6));
                        
                        const date = new Date(timestamp * 1000);
                        const dateKey = date.toISOString().split('T')[0];
                        
                        if (!dailyRates[dateKey]) {
                            dailyRates[dateKey] = [];
                        }
                        
                        dailyRates[dateKey].push({
                            rate,
                            timestamp
                        });
                    } catch (e) {}
                });
                
                // Build history from events
                const eventHistory = [];
                for (const [dateKey, rates] of Object.entries(dailyRates)) {
                    rates.sort((a, b) => a.timestamp - b.timestamp);
                    const lastRate = rates[rates.length - 1].rate;
                    
                    eventHistory.push({
                        date: dateKey,
                        close: lastRate,
                        timestamp: new Date(dateKey + 'T23:59:00').getTime() / 1000,
                        txCount: rates.length,
                        fromEvent: true
                    });
                }
                
                // Merge with saved history
                // First, add all saved history that's not from events
                const savedDates = new Set(eventHistory.map(h => h.date));
                const mergedHistory = [...eventHistory];
                
                priceHistory.forEach(savedItem => {
                    if (!savedDates.has(savedItem.date) && !savedItem.isMissing) {
                        mergedHistory.push(savedItem);
                    }
                });
                
                // Add today if not exists
                const today = new Date().toISOString().split('T')[0];
                if (!mergedHistory.some(h => h.date === today)) {
                    mergedHistory.push({
                        date: today,
                        close: currentRate,
                        timestamp: new Date(today + 'T23:59:00').getTime() / 1000,
                        txCount: 0,
                        isLive: true
                    });
                }
                
                // Sort by date (newest first)
                mergedHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                priceHistory = mergedHistory;
                
                // Check for missing days and fill them
                await checkAndFillMissingDays();
                
                // Save to localStorage
                saveHistoryToStorage();
                
                if (priceHistory.length === 0) {
                    document.getElementById('price-body').innerHTML = `
                        <tr><td colspan="5" class="empty-state">
                            <i class="fas fa-database"></i><br>
                            No transaction history yet
                        </td></tr>
                    `;
                    return;
                }
                
                // Update stats
                updateStatsFromHistory();
                
                renderTable();
                
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </td></tr>
                `;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('price-body');
            let filteredHistory = priceHistory;
            
            if (currentFilter === '30') {
                filteredHistory = priceHistory.slice(0, 30);
            } else if (currentFilter === '7') {
                filteredHistory = priceHistory.slice(0, 7);
            }
            
            const displayHistory = filteredHistory.slice(0, displayedRecords);
            
            if (displayHistory.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No records</td></tr>`;
                document.getElementById('results-count').style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('results-count').style.display = 'inline-block';
            document.getElementById('results-text').textContent = `${filteredHistory.length} days (showing ${displayHistory.length})`;
            
            let html = '';
            displayHistory.forEach((item, index) => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                const rate = item.close;
                const prevRate = index < displayHistory.length - 1 ? displayHistory[index + 1].close : rate;
                const change = ((rate - prevRate) / prevRate * 100).toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const today = new Date().toISOString().split('T')[0];
                const isToday = item.date === today;
                
                html += `
                    <tr>
                        <td><span class="sl-no">#${priceHistory.length - priceHistory.findIndex(h => h.date === item.date)}</span></td>
                        <td class="date-cell">
                            ${formattedDate}
                            ${isToday ? '<span class="badge-new">LIVE</span>' : ''}
                            ${item.is1158 ? '<span class="badge-1158">23:58</span>' : ''}
                            ${item.isSaved && !item.is1158 ? '<span class="badge-saved">SAVED</span>' : ''}
                            ${item.isMissing ? '<span class="badge-missing">FILLED</span>' : ''}
                            ${item.txCount > 0 ? `<span class="tx-badge">${item.txCount} txs</span>` : ''}
                        </td>
                        <td class="rate-cell">${rate.toFixed(6)}</td>
                        <td class="inr-cell">‚Çπ${(rate * INR_RATE).toFixed(2)}</td>
                        <td class="change-cell ${changeClass}">
                            <i class="fas ${changeIcon}"></i> ${Math.abs(change)}%
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            document.getElementById('loadMoreContainer').style.display = 
                displayedRecords < filteredHistory.length ? 'block' : 'none';
        }

        async function updateLiveRate() {
            if (isConnected && sigmaContract) {
                try {
                    const rateBN = await sigmaContract.currentRate();
                    currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                    document.getElementById('liveRateInr').textContent = '‚Çπ' + (currentRate * INR_RATE).toFixed(2);
                } catch (error) {}
            }
        }

        function filterHistory(filter) {
            currentFilter = filter;
            displayedRecords = 20;
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderTable();
        }

        function loadMore() {
            displayedRecords += 20;
            renderTable();
        }

        function exportCSV() {
            if (priceHistory.length === 0) return alert("No data");
            
            let csv = "Date,Rate (USDT),INR,Change %,Transactions,Source,Save Time\n";
            priceHistory.forEach((item, index) => {
                const prevRate = index < priceHistory.length - 1 ? priceHistory[index + 1].close : item.close;
                const change = ((item.close - prevRate) / prevRate * 100).toFixed(2);
                let source = 'Live';
                if (item.fromEvent) source = 'Blockchain';
                else if (item.is1158) source = '11:58 PM Save';
                else if (item.isSaved) source = 'Manual Save';
                else if (item.isMissing) source = 'Filled';
                
                csv += `${item.date},${item.close.toFixed(6)},${(item.close * INR_RATE).toFixed(2)},${change}%,${item.txCount || 0},${source},${item.savedAt || 'N/A'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sigma_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
