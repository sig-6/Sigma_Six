<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SIGMA SIX | PRICE HISTORY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #9d4edd;
            --bg: #0a0b10;
            --card: #161821;
            --text: #ffffff;
            --border: #2d2f3e;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4d4d;
            --gradient: linear-gradient(90deg, #00ffcc, #9d4edd, #ff2a6d, #00ffcc);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .rainbow-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
            z-index: 1000;
        }
        
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .bg-glow {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 1200px;
            height: 1200px;
            background: radial-gradient(circle, rgba(157,78,221,0.15) 0%, rgba(0,255,204,0.1) 25%, transparent 70%);
            z-index: -2;
        }
        
        .crypto-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.3;
            box-shadow: 0 0 10px var(--primary);
            animation: particleFloat 15s infinite linear;
        }
        
        .particle:nth-child(3n) {
            background: var(--secondary);
            box-shadow: 0 0 10px var(--secondary);
        }
        
        .particle:nth-child(5n) {
            background: #ff2a6d;
            box-shadow: 0 0 10px #ff2a6d;
        }
        
        @keyframes particleFloat {
            0% { transform: translate(0, 0) scale(1); opacity: 0.3; }
            25% { transform: translate(100px, -100px) scale(1.5); opacity: 0.6; }
            50% { transform: translate(200px, 0) scale(1); opacity: 0.3; }
            75% { transform: translate(100px, 100px) scale(0.8); opacity: 0.6; }
            100% { transform: translate(0, 0) scale(1); opacity: 0.3; }
        }
        
        .connect-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: #000;
            border: none;
            border-radius: 15px;
            padding: 12px 25px;
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,255,204,0.3);
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .connect-btn.connected {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 80px 20px 30px 20px;
            position: relative;
            z-index: 1;
        }
        
        .nav-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 12px;
            background: rgba(0,255,204,0.1);
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        .nav-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: #888;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 10px;
            animation: rainbow 8s ease infinite;
        }
        
        .header p {
            color: #aaa;
            font-size: 16px;
        }
        
        .live-price-card {
            background: rgba(22,24,33,0.8);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(0,255,204,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .live-price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .live-price-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--success);
            animation: pulseDot 2s infinite;
        }
        
        @keyframes pulseDot {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .live-price-text {
            font-size: 18px;
            color: #aaa;
        }
        
        .live-price-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-left: 15px;
        }
        
        .live-price-inr {
            font-size: 18px;
            color: #ffaa00;
            margin-left: 15px;
        }
        
        .next-update {
            background: rgba(255,170,0,0.1);
            padding: 12px 25px;
            border-radius: 40px;
            border: 1px solid var(--warning);
        }
        
        .next-update i {
            color: var(--warning);
            margin-right: 8px;
        }
        
        .next-update span {
            color: var(--warning);
            font-weight: 600;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            background: rgba(157,78,221,0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .stat-icon i {
            font-size: 24px;
            color: var(--secondary);
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 5px;
        }
        
        .stat-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        
        .history-card {
            background: rgba(22,24,33,0.7);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px;
            border: 1px solid rgba(0,255,204,0.15);
            position: relative;
        }
        
        .history-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
            background-size: 400% 400%;
            animation: rainbow 8s ease infinite;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .card-title {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: #aaa;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
        }
        
        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid rgba(45,47,62,0.5);
            max-height: 600px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(0,255,204,0.1), rgba(157,78,221,0.1));
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            color: var(--primary);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0,255,204,0.2);
            white-space: nowrap;
        }
        
        td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(45,47,62,0.3);
            font-size: 14px;
        }
        
        tr:hover td { background: rgba(255,255,255,0.03); }
        
        .sl-no {
            color: #888;
            font-weight: 600;
        }
        
        .date-cell {
            font-weight: 600;
        }
        
        .rate-cell {
            color: var(--primary);
            font-weight: 700;
            font-size: 16px;
        }
        
        .inr-cell {
            color: #ffaa00;
            font-size: 14px;
        }
        
        .change-cell {
            font-weight: 600;
        }
        
        .badge-new {
            background: var(--success);
            color: #000;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 10px;
            font-weight: 700;
        }
        
        .load-more {
            text-align: center;
            margin-top: 25px;
        }
        
        .load-more-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 12px 30px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .load-more-btn:hover {
            background: var(--secondary);
            color: #000;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .export-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn:hover {
            background: rgba(0,255,204,0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .loading, .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--primary);
        }
        
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: var(--secondary); opacity: 0.5; }
        
        .results-count {
            background: rgba(0,255,204,0.1);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid rgba(0,255,204,0.3);
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--gradient); border-radius: 4px; animation: rainbow 8s ease infinite; }

        @media screen and (max-width: 768px) {
            .container { padding: 70px 15px 20px 15px; }
            .header h1 { font-size: 32px; }
            .live-price-value { font-size: 24px; }
            .stats-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-actions { width: 100%; justify-content: space-between; }
            .action-btn { flex: 1; justify-content: center; }
            .connect-btn { padding: 8px 15px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="rainbow-border"></div>
    <div class="bg-glow"></div>
    <div class="crypto-particles" id="cryptoParticles"></div>
    
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">
        <i class="fas fa-wallet"></i> <span id="btn-text">Connect Wallet</span>
    </button>
    
    <div class="container">
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
            <button class="nav-btn" onclick="loadPriceHistory()"><i class="fas fa-sync-alt"></i> Refresh</button>
            <button class="nav-btn" onclick="exportCSV()"><i class="fas fa-download"></i> Export CSV</button>
        </div>
        
        <div class="header">
            <h1>PRICE HISTORY</h1>
            <p>Daily snapshots at 23:59 • Live Blockchain Data</p>
        </div>
        
        <div class="live-price-card">
            <div class="live-price-info">
                <div class="pulse-dot"></div>
                <span class="live-price-text">LIVE RATE</span>
                <span class="live-price-value" id="liveRate">--</span>
                <span class="live-price-inr" id="liveRateInr">--</span>
            </div>
            <div class="next-update">
                <i class="fas fa-clock"></i>
                <span id="nextUpdate">Next snapshot: 23:59</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-up"></i></div>
                <div class="stat-label">ALL TIME HIGH</div>
                <div class="stat-number" id="ath">--</div>
                <div class="stat-trend trend-up" id="athDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-arrow-down"></i></div>
                <div class="stat-label">ALL TIME LOW</div>
                <div class="stat-number" id="atl">--</div>
                <div class="stat-trend trend-down" id="atlDate"><i class="fas fa-calendar"></i> --</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-label">AVERAGE (30D)</div>
                <div class="stat-number" id="avg30">--</div>
                <div class="stat-trend"><i class="fas fa-percent"></i> <span id="avg30Change">--</span></div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                <div class="stat-label">RECORDS</div>
                <div class="stat-number" id="totalRecords">--</div>
                <div class="stat-trend"><i class="fas fa-history"></i> <span id="daysTracked">-- days</span></div>
            </div>
        </div>
        
        <div class="history-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-table"></i> DAILY SNAPSHOTS
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterHistory('all')">ALL</button>
                    <button class="filter-btn" onclick="filterHistory('30')">30 DAYS</button>
                    <button class="filter-btn" onclick="filterHistory('7')">7 DAYS</button>
                </div>
            </div>
            
            <div class="results-count" id="results-count" style="display: none;">
                <i class="fas fa-history"></i> <span id="results-text">0 records</span>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Sl. No</th>
                            <th>Date (23:59)</th>
                            <th>Rate (USDT)</th>
                            <th>≈ INR</th>
                            <th>24h Change</th>
                        </tr>
                    </thead>
                    <tbody id="price-body">
                        <tr><td colspan="5" class="loading"><i class="fas fa-spinner fa-spin"></i><br>Connect wallet to view price history</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="load-more" id="loadMoreContainer" style="display: none;">
                <button class="load-more-btn" onclick="loadMore()"><i class="fas fa-history"></i> LOAD MORE</button>
            </div>
            
            <div class="export-buttons">
                <button class="export-btn" onclick="exportCSV()"><i class="fas fa-file-csv"></i> EXPORT CSV</button>
                <button class="export-btn" onclick="loadPriceHistory()"><i class="fas fa-sync-alt"></i> REFRESH</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONTRACT CONFIGURATION ==========
        const SIGMA_ADDRESS = "0x068Aaba73Fd754F21140E2F13DA177ce7251A299";
        
        // SIMPLIFIED ABI - SIRF VIEW FUNCTIONS KI NEED HAI
        const SIGMA_ABI = [
            "function currentRate() view returns (uint256)",
            "function getSellRate() view returns (uint256)",
            "function ath() view returns (uint256)",
            "function atl() view returns (uint256)",
            "function dailyHistory(uint256) view returns (uint256 open, uint256 high, uint256 low, uint256 close, uint256 timestamp)",
            "function lastHistoryDay() view returns (uint256)"
        ];

        // State
        let provider, userAddress;
        let sigmaContract;
        let isConnected = false;
        let priceHistory = [];
        let currentFilter = 'all';
        let displayedRecords = 20;
        let currentRate = 0;
        const INR_RATE = 95;

        // Initialize
        window.onload = async () => {
            createParticles();
            
            if (window.ethereum) {
                provider = new ethers.BrowserProvider(window.ethereum);
                try {
                    const accounts = await provider.send("eth_accounts", []);
                    if (accounts && accounts.length > 0) {
                        await connectWallet(true);
                    }
                } catch (e) {
                    console.log("Auto-connect failed:", e);
                }
            }
            
            setInterval(updateCountdown, 60000);
            updateCountdown();
        };

        function createParticles() {
            const container = document.getElementById('cryptoParticles');
            for (let i = 0; i < 30; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.top = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 20 + 's';
                container.appendChild(p);
            }
        }

        // ========== FIXED CONNECT WALLET FUNCTION ==========
        async function connectWallet(silent = false) {
            if (!window.ethereum) {
                if (!silent) {
                    alert("Please install MetaMask!");
                    window.open("https://metamask.io/download/", "_blank");
                }
                return;
            }
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                
                // Request accounts
                const accounts = await provider.send("eth_requestAccounts", []);
                
                // ✅ FIX: accounts array mein strings hain, objects nahi
                userAddress = accounts[0].toLowerCase();
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 137n) {
                    if (!silent) {
                        alert("Please switch to Polygon Mainnet");
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x89' }],
                            });
                        } catch (switchError) {}
                    }
                    return;
                }
                
                // Create contract instance with provider (signer nahi chahiye view functions ke liye)
                sigmaContract = new ethers.Contract(SIGMA_ADDRESS, SIGMA_ABI, provider);
                
                isConnected = true;
                
                // Update UI
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                document.getElementById('connectBtn').classList.add('connected');
                
                // Load data
                await loadPriceHistory();
                
                // Set up event listeners
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
                // Start live rate updates
                setInterval(updateLiveRate, 10000);
                
            } catch (error) {
                console.error("Connection error:", error);
                if (!silent) alert("Connection failed: " + error.message);
            }
        }

        // ✅ FIX: Handle account changes properly
        async function handleAccountsChanged(accounts) {
            if (accounts && accounts.length > 0) {
                userAddress = accounts[0].toLowerCase();
                document.getElementById('btn-text').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
                await loadPriceHistory();
            } else {
                // Disconnected
                isConnected = false;
                document.getElementById('connectBtn').classList.remove('connected');
                document.getElementById('btn-text').textContent = 'Connect Wallet';
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="loading">
                        <i class="fas fa-plug"></i><br>
                        Wallet disconnected
                    </td></tr>
                `;
            }
        }

        // Load Price History from Contract
        async function loadPriceHistory() {
            if (!isConnected || !sigmaContract) {
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="loading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Please connect wallet to view price history
                    </td></tr>
                `;
                return;
            }
            
            try {
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="loading">
                        <i class="fas fa-spinner fa-spin"></i><br>
                        Fetching live blockchain data...
                    </td></tr>
                `;
                
                // Get current rate
                const rateBN = await sigmaContract.currentRate();
                currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                
                document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                document.getElementById('liveRateInr').textContent = '≈ ₹' + (currentRate * INR_RATE).toFixed(2);
                
                // Get ATH and ATL
                const ath = await sigmaContract.ath();
                const atl = await sigmaContract.atl();
                document.getElementById('ath').textContent = ethers.formatUnits(ath, 6) + ' USDT';
                document.getElementById('atl').textContent = ethers.formatUnits(atl, 6) + ' USDT';
                
                // Get last history day
                const lastDay = await sigmaContract.lastHistoryDay();
                const history = [];
                
                // Fetch daily history
                for (let i = 0; i <= lastDay; i++) {
                    try {
                        const day = await sigmaContract.dailyHistory(i);
                        if (day.close > 0) {
                            history.push({
                                index: i,
                                close: parseFloat(ethers.formatUnits(day.close, 6)),
                                timestamp: Number(day.timestamp)
                            });
                        }
                    } catch (e) {
                        // Skip if no data
                    }
                }
                
                // Sort by timestamp (newest first)
                history.sort((a, b) => b.timestamp - a.timestamp);
                priceHistory = history;
                
                if (priceHistory.length === 0) {
                    document.getElementById('price-body').innerHTML = `
                        <tr><td colspan="5" class="empty-state">
                            <i class="fas fa-database"></i><br>
                            No price history available yet
                        </td></tr>
                    `;
                    document.getElementById('totalRecords').textContent = '0';
                    document.getElementById('daysTracked').textContent = '0 days';
                    return;
                }
                
                // Update stats
                updateStats();
                
                // Find ATH/ATL dates
                const athRecord = history.reduce((max, item) => item.close > max.close ? item : max, history[0]);
                const atlRecord = history.reduce((min, item) => item.close < min.close ? item : min, history[0]);
                
                if (athRecord && athRecord.timestamp) {
                    document.getElementById('athDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(athRecord.timestamp * 1000).toLocaleDateString()}`;
                }
                if (atlRecord && atlRecord.timestamp) {
                    document.getElementById('atlDate').innerHTML = `<i class="fas fa-calendar"></i> ${new Date(atlRecord.timestamp * 1000).toLocaleDateString()}`;
                }
                
                document.getElementById('totalRecords').textContent = history.length;
                document.getElementById('daysTracked').textContent = history.length + ' days';
                
                renderTable();
                
            } catch (error) {
                console.error("Error loading price history:", error);
                document.getElementById('price-body').innerHTML = `
                    <tr><td colspan="5" class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </td></tr>
                `;
            }
        }

        function updateStats() {
            if (priceHistory.length === 0) return;
            
            // Calculate 30-day average
            const last30 = priceHistory.slice(0, Math.min(30, priceHistory.length));
            const avg30 = last30.reduce((sum, item) => sum + item.close, 0) / last30.length;
            document.getElementById('avg30').textContent = avg30.toFixed(6) + ' USDT';
            
            // Calculate 30-day change
            if (last30.length >= 2) {
                const first = last30[last30.length - 1].close;
                const last = last30[0].close;
                const change = ((last - first) / first * 100).toFixed(2);
                document.getElementById('avg30Change').textContent = change + '%';
                document.getElementById('avg30Change').style.color = change >= 0 ? 'var(--success)' : 'var(--danger)';
            }
        }

        function renderTable() {
            const tbody = document.getElementById('price-body');
            let filteredHistory = priceHistory;
            
            if (currentFilter === '30') {
                filteredHistory = priceHistory.slice(0, 30);
            } else if (currentFilter === '7') {
                filteredHistory = priceHistory.slice(0, 7);
            }
            
            const displayHistory = filteredHistory.slice(0, displayedRecords);
            
            if (displayHistory.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="empty-state">
                        <i class="fas fa-database"></i><br>
                        No records found
                    </td></tr>
                `;
                document.getElementById('results-count').style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('results-count').style.display = 'inline-block';
            document.getElementById('results-text').textContent = `${filteredHistory.length} records (showing ${displayHistory.length})`;
            
            let html = '';
            displayHistory.forEach((item, index) => {
                const date = new Date(item.timestamp * 1000);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) + ' 23:59';
                
                const rate = item.close;
                const prevRate = index < displayHistory.length - 1 ? displayHistory[index + 1].close : rate;
                const change = ((rate - prevRate) / prevRate * 100).toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeIcon = change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const today = new Date();
                const isToday = today.toDateString() === date.toDateString();
                
                html += `
                    <tr>
                        <td><span class="sl-no">#${priceHistory.length - item.index}</span></td>
                        <td class="date-cell">
                            ${formattedDate}
                            ${isToday ? '<span class="badge-new">LATEST</span>' : ''}
                        </td>
                        <td class="rate-cell">${rate.toFixed(6)} USDT</td>
                        <td class="inr-cell">₹${(rate * INR_RATE).toFixed(2)}</td>
                        <td class="change-cell ${changeClass}">
                            <i class="fas ${changeIcon}"></i> ${Math.abs(change)}%
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            if (displayedRecords < filteredHistory.length) {
                document.getElementById('loadMoreContainer').style.display = 'block';
            } else {
                document.getElementById('loadMoreContainer').style.display = 'none';
            }
        }

        async function updateLiveRate() {
            if (isConnected && sigmaContract) {
                try {
                    const rateBN = await sigmaContract.currentRate();
                    currentRate = parseFloat(ethers.formatUnits(rateBN, 6));
                    document.getElementById('liveRate').textContent = currentRate.toFixed(6) + ' USDT';
                    document.getElementById('liveRateInr').textContent = '≈ ₹' + (currentRate * INR_RATE).toFixed(2);
                } catch (error) {
                    console.log("Error updating live rate:", error);
                }
            }
        }

        function updateCountdown() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(23, 59, 0, 0);
            
            if (now > midnight) {
                midnight.setDate(midnight.getDate() + 1);
            }
            
            const diffMs = midnight - now;
            const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('nextUpdate').innerHTML = 
                `<i class="fas fa-clock"></i> Next snapshot: ${diffHrs}h ${diffMins}m`;
        }

        function filterHistory(filter) {
            currentFilter = filter;
            displayedRecords = 20;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderTable();
        }

        function loadMore() {
            displayedRecords += 20;
            renderTable();
        }

        function exportCSV() {
            if (priceHistory.length === 0) {
                alert("No data to export");
                return;
            }
            
            let csv = "Sl.No,Date,Rate (USDT),INR,24h Change\n";
            
            priceHistory.forEach((item, index) => {
                const date = new Date(item.timestamp * 1000).toLocaleDateString();
                const rate = item.close;
                const prevRate = index < priceHistory.length - 1 ? priceHistory[index + 1].close : rate;
                const change = ((rate - prevRate) / prevRate * 100).toFixed(2);
                
                csv += `${priceHistory.length - index},${date} 23:59,${rate.toFixed(6)},${(rate * INR_RATE).toFixed(2)},${change}%\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sigma_price_history_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
