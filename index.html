<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGMA SIX | Official DApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ffcc; --bg: #0a0b10; --card: #161821; --text: #ffffff; --border: #2d2f3e; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 450px; }
        .card { background: var(--card); border-radius: 24px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .header h1 { color: var(--primary); text-align: center; margin: 0; font-size: 26px; letter-spacing: 2px; }
        .header p { text-align: center; font-size: 11px; color: #666; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: 700; color: var(--primary); margin-top: 4px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: #000; padding: 5px; border-radius: 14px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-radius: 10px; font-weight: 700; font-size: 14px; color: #555; transition: 0.3s; }
        .tab.active { background: var(--primary); color: #000; }
        .input-area { background: #000; border: 1px solid var(--border); border-radius: 16px; padding: 18px; margin-bottom: 15px; }
        .input-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 10px; }
        input { background: transparent; border: none; color: white; font-size: 26px; width: 100%; outline: none; font-weight: 600; }
        .calc-box { background: rgba(0,255,204,0.05); border: 1px dashed var(--primary); border-radius: 12px; padding: 15px; font-size: 13px; margin-bottom: 15px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .btn { width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 800; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; text-transform: uppercase; }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 4px 15px rgba(0,255,204,0.2); }
        .btn-wallet { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-bottom: 20px; }
        .ref-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-top: 20px; }
        .balance-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); font-size: 13px; }
        #status-msg { font-size: 11px; text-align: center; margin-top: 10px; color: var(--primary); font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn btn-wallet" id="connectBtn" onclick="connect()">Connect MetaMask</button>
    
    <div class="card">
        <div class="header">
            <h1>SIGMA SIX</h1>
            <p>Stable Algorithm â€¢ 5-Level Rewards</p>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">Buy Rate</div><div id="brate" class="stat-value">0.0112</div></div>
            <div class="stat-box"><div class="stat-label">Sell Rate</div><div id="srate" class="stat-value">0.0111</div></div>
        </div>

        <div class="tabs">
            <div id="t-buy" class="tab active" onclick="setMode('buy')">BUY SIG6</div>
            <div id="t-sell" class="tab" onclick="setMode('sell')">SELL SIG6</div>
        </div>

        <div class="input-area">
            <div class="input-header"><span>Amount in SIG6</span><span style="color:var(--primary);cursor:pointer" onclick="max()">MAX</span></div>
            <input type="number" id="amt" placeholder="0" oninput="calc()">
        </div>

        <div class="calc-box">
            <div class="row"><span id="out-label">Total USDT to Pay:</span> <span id="out-amt" style="color:var(--primary); font-weight:800">0.00 USDT</span></div>
            <div class="row"><span>Admin Tax (1%):</span> <span id="tax-amt" style="color:#ff4d4d">0.0000</span></div>
            <div class="row" id="upline-display"><span style="color:#888;">Upline Address:</span> <span id="upline-addr" style="font-size:10px; color:#aaa;">None</span></div>
        </div>

        <button class="btn btn-primary" id="mainBtn" onclick="action()">APPROVE USDT</button>
        <div id="status-msg">Ready to trade</div>

        <div class="ref-box" id="ref-ui" style="display:none">
            <div class="row"><span style="font-size:11px; color:#888;">YOUR REFERRAL LINK</span></div>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="text" id="ref-link" readonly style="font-size:11px; background:#111; padding:8px; border-radius:8px; color:#00ffcc; border:1px solid #333;">
                <button onclick="copyRef()" style="background:var(--primary); border:none; border-radius:8px; padding:0 15px; font-weight:800; font-size:11px; cursor:pointer">COPY</button>
            </div>
        </div>

        <div class="balance-footer">
            <div class="row"><span>USDT Balance:</span> <span id="bal-usdt">0.000</span></div>
            <div class="row"><span>SIG6 Balance:</span> <span id="bal-sig">0.000</span></div>
            <div class="row"><span>POL Balance:</span> <span id="bal-pol">0.000</span></div>
        </div>
    </div>
</div>

<script>
    const S_ADDR = "0x52472d91b00A005dFE7256Ce68D135aAFA96583b";
    const U_ADDR = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";
    let mode = 'buy', buyR = 0.0112, sellR = 0.0111, signer, addr, provider;

    // Save Referral Upline from URL even if page refreshes
    function handleUpline() {
        const params = new URLSearchParams(window.location.search);
        let ref = params.get('ref');
        if (ref && ethers.isAddress(ref)) {
            localStorage.setItem('sigma_ref', ref);
        }
        let currentRef = localStorage.getItem('sigma_ref') || "0x0000000000000000000000000000000000000000";
        document.getElementById('upline-addr').innerText = currentRef.slice(0,10) + "...";
        return currentRef;
    }

    async function connect() {
        if (!window.ethereum) return alert("Please open this in MetaMask Browser");
        provider = new ethers.BrowserProvider(window.ethereum);
        const acc = await provider.send("eth_requestAccounts", []);
        addr = acc[0]; signer = await provider.getSigner();
        document.getElementById('connectBtn').innerText = addr.slice(0,6)+"..."+addr.slice(-4);
        document.getElementById('ref-ui').style.display = 'block';
        updateRefLink();
        sync();
    }

    async function sync() {
        if (!addr) return;
        const uc = new ethers.Contract(U_ADDR, ["function balanceOf(address) view returns (uint256)", "function allowance(address,address) view returns (uint256)"], provider);
        const sc = new ethers.Contract(S_ADDR, ["function balanceOf(address) view returns (uint256)", "function buyRate() view returns (uint256)", "function getSellRate() view returns (uint256)"], provider);
        
        try {
            const [pb, ub, sb, br, sr, alw] = await Promise.all([
                provider.getBalance(addr),
                uc.balanceOf(addr),
                sc.balanceOf(addr),
                sc.buyRate(),
                sc.getSellRate(),
                uc.allowance(addr, S_ADDR)
            ]);

            document.getElementById('bal-pol').innerText = parseFloat(ethers.formatEther(pb)).toFixed(3) + " POL";
            document.getElementById('bal-usdt').innerText = parseFloat(ethers.formatUnits(ub, 6)).toFixed(3) + " USDT";
            document.getElementById('bal-sig').innerText = parseFloat(ethers.formatEther(sb)).toFixed(2) + " SIG6";
            
            buyR = parseFloat(ethers.formatUnits(br, 6));
            sellR = parseFloat(ethers.formatUnits(sr, 6));
            document.getElementById('brate').innerText = buyR.toFixed(4);
            document.getElementById('srate').innerText = sellR.toFixed(4);

            const requiredUsdt = (parseFloat(document.getElementById('amt').value || 0) * buyR) * 1.01;
            const currentAlw = parseFloat(ethers.formatUnits(alw, 6));

            if(mode === 'buy') {
                document.getElementById('mainBtn').innerText = (currentAlw >= requiredUsdt && requiredUsdt > 0) ? "BUY SIGMA" : "APPROVE USDT";
            } else {
                document.getElementById('mainBtn').innerText = "SELL SIGMA";
            }
        } catch (e) { console.error(e); }
    }

    function calc() {
        const v = parseFloat(document.getElementById('amt').value) || 0;
        let tax = 0, final = 0;
        if (mode === 'buy') {
            const netUsdt = v * buyR;
            tax = netUsdt * 0.01;
            final = netUsdt + tax;
            document.getElementById('out-label').innerText = "Total USDT to Pay:";
            document.getElementById('out-amt').innerText = final.toFixed(4) + " USDT";
        } else {
            const totalVal = v * sellR;
            tax = totalVal * 0.01;
            final = totalVal - tax;
            document.getElementById('out-label').innerText = "Total USDT Receive:";
            document.getElementById('out-amt').innerText = final.toFixed(4) + " USDT";
        }
        document.getElementById('tax-amt').innerText = tax.toFixed(4) + " USDT";
        sync();
    }

    function setMode(m) {
        mode = m;
        document.getElementById('t-buy').className = m === 'buy' ? 'tab active' : 'tab';
        document.getElementById('t-sell').className = m === 'sell' ? 'tab active' : 'tab';
        sync();
    }

    async function action() {
        if (!signer) return connect();
        const v = document.getElementById('amt').value;
        if (!v || v <= 0) return alert("Enter amount");
        const msg = document.getElementById('status-msg');
        
        try {
            if (mode === 'buy') {
                const uc = new ethers.Contract(U_ADDR, ["function approve(address,uint256) returns (bool)", "function allowance(address,address) view returns (uint256)"], signer);
                const requiredUsdt = (parseFloat(v) * buyR) * 1.01;
                const alw = await uc.allowance(addr, S_ADDR);
                
                if (parseFloat(ethers.formatUnits(alw, 6)) < requiredUsdt) {
                    msg.innerText = "Approving USDT...";
                    const tx = await uc.approve(S_ADDR, ethers.MaxUint256);
                    await tx.wait();
                    msg.innerText = "Approval Success!";
                    sync();
                } else {
                    const sc = new ethers.Contract(S_ADDR, ["function buySigma(uint256,address)"], signer);
                    const upline = handleUpline();
                    msg.innerText = "Buying SIGMA...";
                    const tx = await sc.buySigma(ethers.parseEther(v), upline);
                    await tx.wait();
                    msg.innerText = "Purchase Successful!";
                    sync();
                }
            } else {
                const sc = new ethers.Contract(S_ADDR, ["function sellSigma(uint256)"], signer);
                msg.innerText = "Selling SIGMA...";
                const tx = await sc.sellSigma(ethers.parseEther(v));
                await tx.wait();
                msg.innerText = "Sale Successful!";
                sync();
            }
        } catch (e) { msg.innerText = "Error: " + (e.reason || "Check Balance/Gas"); }
    }

    function updateRefLink() {
        // This will now use the GitHub URL automatically
        const link = window.location.origin + window.location.pathname + "?ref=" + addr;
        document.getElementById('ref-link').value = link;
    }

    function copyRef() {
        const linkInput = document.getElementById('ref-link');
        linkInput.select();
        navigator.clipboard.writeText(linkInput.value);
        document.getElementById('status-msg').innerText = "Referral Link Copied!";
    }

    function max() {
        const u = document.getElementById('bal-usdt').innerText.split(' ')[0];
        const s = document.getElementById('bal-sig').innerText.split(' ')[0];
        if (mode === 'buy') {
            document.getElementById('amt').value = ((parseFloat(u) / 1.01) / buyR).toFixed(2);
        } else {
            document.getElementById('amt').value = s;
        }
        calc();
    }

    window.onload = handleUpline;
</script>
</body>
</html>
